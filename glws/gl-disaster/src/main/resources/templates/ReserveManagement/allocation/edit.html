<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改调拨单')" />
    <th:block th:include="include :: datetimepicker-css" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-allocation-edit" th:object="${kAllocation}">
            <input  id="allocationId" name="id" th:field="*{id}" type="hidden">

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">调拨单号：</label>
                        <div class="col-sm-8">
                            <input id="oddnumber" name="oddnumber" th:field="*{oddnumber}" class="form-control" type="text" maxlength="15">
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">

                    <div class="form-group">
                        <label class="col-sm-3 control-label">名称：</label>
                        <div class="col-sm-8">
                            <input  name="dbName" th:field="*{dbName}" class="form-control" type="text">
                        </div>
                    </div>
                </div>
            </div>


            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">申请地区：</label>
                        <div class="col-sm-8">
                            <input id="applicationArea" name="applicationArea" th:field="*{applicationArea}" class="form-control" type="text">
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">

                    <label class="col-sm-3 control-label">调出时间：</label>
                    <div class="col-sm-8">
                        <div class="input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input id="test2" name="allocationTime" th:value="${#dates.format(kAllocation.allocationTime, 'yyyy-MM-dd')}" class="form-control" placeholder="yyyy-MM-dd" type="text">
                        </div>
                    </div>
                </div>
            </div>
            </div>


            <div class="col-sm-12 select-table">
                <div class="row" style="margin-left:1.5px;margin-bottom: 1px">
                    <div >
                        <button type="button" style="background-color: rgba(48,146,62, 0.9)" class="btn btn-sm btn-primary" onclick="addRow()"><i class="fa fa-check"></i>新增一行</button>&nbsp;
                        <button type="button"  style="background-color: rgba(48,146,62, 0.9)" class="btn btn-sm btn-primary" onclick="resolveAll()"><i class="fa fa-check"></i>修改物资</button>&nbsp;

                    </div>
                </div>
                <table id="mytable"  class="tg" name="test"border="0px solid rgba(48,146,62, 0.9)" cellspacing="0" cellpadding="0" style="width: 100%;height: 35px">
                    <tr id="tr1"  align="center" style="background-color: rgba(48,146,62, 0.9)">
                        <td style="width: 10%;height:35px;" ><font size="2" color="white">物资序号</font></td>
                        <td style="width: 15%;height:35px; " ><font size="2" color="white"><span style="color: red; ">*</span>物资类型</font></td>
                        <td style="width: 15%;height:35px; " ><font size="2" color="white"><span style="color: red; ">*</span>物资名称</font></td>
                        <td style="width: 15%;height:35px; " ><font size="2" color="white"><span style="color: red; ">*</span>型号</font></td>
                        <td style="width: 15%;height:35px; " ><font size="2" color="white"><span style="color: red; ">*</span>数量(千)</font></td>
                        <td style="width: 15%;height:35px; " ><font size="2" color="white"><span style="color: red; ">*</span>厂商信息</font></td>
                        <td style="width: 15%;height:35px; "><font size="2" color="white"><span style="color: red; ">*</span>备注</font></td>

                    </tr>

                    <tr th:each="KAllocation,userStat : ${KInstocklist}">
                        <td>
                            <input  id="publishID_1" name="publishId_1"   value="1" style="width: 100%;height: 35px;" required readonly="readonly" >

                            <input  th:id="id"   name="id" type="text" style="width: 100%; height: 35px" th:type="hidden" th:value="${KAllocation.id}" readonly> </td>
                        <td>
                            <select name="type"  th:onchange="'getNames('+${userStat.index}+')'" style="width: 100%; height: 35px" th:with="type=${@dict.getTypeWz()}" th:id="'typeut_'+${userStat.index}" >
                                <option th:each="dict : ${type}" th:selected="${KAllocation.type.contains(dict.dictValue)}" th:value="${dict.dictValue}" th:text="${dict.dictLabel}" ></option>
                            </select>
                        </td>
                        <td>
                            <select th:id="'manufactorName_'+${userStat.index}" name="name" style="width: 100%; height: 35px" th:with="type=${@dict.getTypeWzN(KAllocation.type)}">
                                <option th:each="dict : ${type}" th:selected="${KAllocation.name.contains(dict.dictValue)}" th:value="${dict.dictValue}" th:text="${dict.dictLabel}" ></option>
                            </select>

                        </td>
                        <td><input name="model" type="text"  style="width: 100%; height: 35px"   th:value="${KAllocation.model}" > </td>

                        <td><input name="goodsNumber" type="text"  style="width: 100%; height: 35px"  maxlength="10" th:value="${KAllocation.goodsNumber}" min onkeyup="value=value.replace(/[^\d]/g,'')"> </td>

                        <td><input name="manufactor" type="text"  style="width: 100%; height: 35px"   th:value="${KAllocation.manufactor}" > </td>
                        <td><input name="reason" type="text" style="width: 100%; height: 35px"   th:value="${KAllocation.reason}" > </td>

                        <td style="min-width:66px;"><a class="btn btn-danger btn-xs"   th:onclick="'del11('+${KAllocation.id}+' )'"><i class="fa fa-remove"></i>删除</a></td>
                    </tr>
                </table>

            </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: datetimepicker-js" />
    <script type="text/javascript">
        var prefix = ctx + "reserves/allocation";
        $("#form-allocation-edit").validate({
            focusCleanup: true
        });

        function submitHandler() {

            if ($.validate.form()) {
                $.operate.save(prefix + "/edit", $('#form-allocation-edit').serialize());
            }
        }

        $("input[name='allocationTime']").datetimepicker({
            format: "yyyy-mm-dd",
            minView: "month",
            autoclose: true
        });




        //省市区三级联动
        $(function(){
            //getType();
            //getProvinces();
            var op1 = document.createElement("option");
            document.getElementById("manufactorName").appendChild(op1);

        });
    </script>
    <script type="text/javascript">
        // ===== 加载物资类型 =====
        function getProvinces() {
            var url=ctx+"reserves/instock/getType";
            $.ajax({
                "url": url,
                "type": "GET",
                "dataType": "json",
                "success": function(data) {
                    //alert(JSON.stringify(data))
                    var op = document.createElement("option");
                    document.getElementById("manufactorType").appendChild(op);
                    for (var i = 0; i < data.length; i++) {
                        var op = document.createElement("option");
                        op.value = data[i].materialType;
                        op.text = data[i].materialName;
                        document.getElementById("manufactorType").appendChild(op);
                    }
                }
            });

            getCities();
        }


        // ===== 加载物资列表 =====
        function getCities() {
            $("#manufactorName").empty();
            var url=ctx+"reserves/instock/getGoods";
            var data = "provinceCode=" + $("#manufactorType").val();
            $.ajax({
                "url": url,
                "data": data,
                "type": "GET",
                "dataType": "json",
                "success": function(data) {

                    var op = document.createElement("option");
                    document.getElementById("manufactorName").appendChild(op);
                    for (var i = 0; i < data.length; i++) {
                        var op = document.createElement("option");
                        op.value = data[i].materialId;
                        op.text = data[i].materialName;
                        document.getElementById("manufactorName").appendChild(op);
                    }
                }
            });

        }


        function getType(number) {
            var url=ctx+"reserves/instock/getType";
            $.ajax({
                "url": url,
                "type": "GET",
                "dataType": "json",
                "success": function(data) {
                    //alert(JSON.stringify(data))
                    var op = document.createElement("option");
                    document.getElementById("manufactorType_"+number).appendChild(op);
                    for (var i = 0; i < data.length; i++) {
                        var op = document.createElement("option");
                        op.value = data[i].materialType;
                        op.text = data[i].materialName;
                        document.getElementById("manufactorType_"+number).appendChild(op);
                    }
                }
            });



            getName(number);

        }
        function getNames(number) {
            $("#manufactorName_"+number).empty();
            var url=ctx+"reserves/instock/getGoods";
            var data = "provinceCode=" + $("#typeut_"+number).val();
            $.ajax({
                "url": url,
                "data": data,
                "type": "GET",
                "dataType": "json",
                "success": function(data) {

                    var op = document.createElement("option");
                    document.getElementById("manufactorName_"+number).appendChild(op);
                    for (var i = 0; i < data.length; i++) {
                        var op = document.createElement("option");
                        op.value = data[i].materialName;
                        op.text = data[i].materialName;
                        document.getElementById("manufactorName_"+number).appendChild(op);
                    }
                }
            });

        }
        function getName(number) {
            $("#manufactorName_"+number).empty();
            var url=ctx+"reserves/instock/getGoods";
            var data = "provinceCode=" + $("#manufactorType_"+number).val();
            $.ajax({
                "url": url,
                "data": data,
                "type": "GET",
                "dataType": "json",
                "success": function(data) {

                    var op = document.createElement("option");
                    document.getElementById("manufactorName_"+number).appendChild(op);
                    for (var i = 0; i < data.length; i++) {
                        var op = document.createElement("option");
                        op.value = data[i].materialId;
                        op.text = data[i].materialName;
                        document.getElementById("manufactorName_"+number).appendChild(op);
                    }
                }
            });

        }


        /* 删除一行 */
        function del11(ids) {
            var long=document.getElementById("mytable").rows.length;
            if(long>2){
                if(ids==null || ids==''){
                    var tab = ids.parentNode.parentNode;
                    tab.parentNode.removeChild(tab);
                    dataValidation();
                }  else{
                    $.modal.confirm("确认要删除吗？", function () {

                    var urll = ctx + "reserves/instock/del/"+ids;
                    $.get(urll,function(data){
                        if(data='200'){
                            layer.alert("删除成功！")

                            window.location.reload()  //刷新页面
                        }else{
                            layer.alert("删除失败！")

                        }
                    });

                    })
                }


            }else{
                layer.alert("至少保留一行！")

            }


        }


        //追加一行
        function addRow() {
            var tableNode =	document.getElementById("mytable");
            var trNodeList = tableNode.getElementsByTagName("tr");
            //得到最后一行(tr)的所有td
            var tdNodeList = trNodeList[trNodeList.length - 1].getElementsByTagName("td");
            var td_input_name = tdNodeList[0].getElementsByTagName("input")[0].name;
            var strIndex = td_input_name.indexOf("_");
            var number = td_input_name.substring(strIndex + 1)

            var trNode = document.createElement("tr");
            number++;
            $("#mytable").append("<tr>" +
                "<td> <input name=\"publishId_"+number+"\"  id=\"publishId\" value="+number+" type=\"text\" style=\"width: 100%; height:35px;\"  min readonly=\"readonly\"> </td>" +
                "<td><select id=\"manufactorType_"+number+"\"  name=\"type\" onchange=\"getName("+number+")\" style=\"width: 100%;height:35px;\" > </select> </td>"+
                "<td><select id=\"manufactorName_"+number+"\" name=\"name\" style=\"width: 100%;height:35px;\" > </select> </td>"+
                "<td> <input name=\"model\" type=\"text\" style=\"width: 100%; height:35px;\"  > </td>"+
                "<td> <input name=\"goodsNumber\" type=\"text\" style=\"width: 100%; height:35px;\"  min maxlength=\"6\" onkeyup=\"value=value.replace(/[^\\d]/g,'')\"> </td>"+
                "<td> <input name=\"manufactor\" type=\"text\"  style=\"width: 100%; height:35px;\"  > </td>"+
                "<td> <input name=\"reason\" type=\"text\" style=\"width: 100%; height:35px;\"  > </td>" +
                " <td><a class=\"btn btn-danger btn-xs\" onclick=\"del11(this)\"><i class=\"fa fa-remove\"></i>删除</a></td></tr>")
            getType(number)
            //数据校验
            $('input').blur(function () {
                dataValidation(this);
            })
        }



        function resolveAll() {
            if ($.validate.form()) {
                //var name=$("#name").val();
               // var warehousing=$("#test2").val();
                var allocationId=$("#allocationId").val();
               // var applicationArea=$("#applicationArea").val();
                //var oddnumber=$("#oddnumber").val();


                for(var i = 0; i < $('select').length; i++){
                    let current = $('select').eq(i).val();
                    if(current == ""){
                        layer.alert("未选择出库物资 !")

                        return;
                    }
                }

               /* for(var i = 0; i < $('input').length; i++){
                    let current = $('input').eq(i).val();
                    if(current == ""){
                        layer.alert("请完整填写出库信息 !")


                        return;
                    }
                }*/
                /*let list = ['wlScale','wlInvestment','jmSize','jmMoney','xmSize','xmMoney','hqlxSize','hqlxMoney','smhzlSize','smhzlMoney','thzyglSize','thzyglMoney','rgscdSize','rgscdMoney','hspjSize','hspjMoney','httSize','httMoney','dhcSize','dhcMoney'];
                for(var i = 0; i < list.length; i++){
                    let current = $('#' + list[i]).text();
                    if(parseInt(current) != 0){
                        $.modal.confirm("未全部分解,请全部分解后提交", function () {})
                        return;
                    }
                }*/
                var orderItemArray = new Array();
                $("#form-allocation-edit tr").each(function () {
                    //this代表当前dom对象tr
                    var that = this;
                    var orderItemObj = new Object();
                    $(that).find("select,input").each(function () {
                        var name = $(this).attr("name");
                        orderItemObj[name] = $(this).val();
                    });
                    //orderItemObj["warehousing"] = warehousing;

                    orderItemObj["allocationId"] = allocationId;


                    orderItemArray.push(orderItemObj);
                });
                var url = prefix + "/editFenJie";
                $.ajax({
                    url: url,
                    dataType: "json",
                    contentType: "application/json;charsetset=UTF-8",//必
                    type: "post",
                    cache: false,
                    data: JSON.stringify(orderItemArray),//必须
                    // data: JSON.stringify({orderItemArray: orderItemArray,reserve: reserve,warehousingTime:warehousingTime}),
                    success: function (obj) {
                        if (obj == "400") {
                            layer.alert("物资修改成功！");

                            /* layer.alert('修改成功！', function (index) {
                                 //加载刷新父类页面并关闭弹窗
                               /!*  window.parent.location.reload();
                                 parent.layer.closeAll('iframe');*!/
                             });*/
                        } else if (obj == "404") {
                            layer.alert("修改失败！");
                        } else {
                            layer.alert("发布失败，请查看网络！！！");
                        }
                    },
                    error: function (textStatus, e) {
                        layer.alert("系统ajax交互错误: ");
                    }
                });
            }
        }
    </script>
</body>
</html>