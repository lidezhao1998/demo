<!DOCTYPE html>
<html lang="zh">
<head>
	<th:block th:include="include :: header('上传取样照片')" />
	<th:block th:include="include :: bootstrap-fileinput-css" />
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <div class="form-group">
                            <label class="font-noraml">上传照片</label>
	                        <div class="file-loading">
					            <input id="fileinput-demo-2" type="file" multiple>
					        </div>
                        </div>
                        <hr>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-fileinput-js" />
    <script type="text/javascript">
    $(document).ready(function () {
        var obj = document.getElementById("photoUrl");//储存图图片id
        var ids=[];
        var initialPreview=[];
        var initialPreviewConfig=[];
        $("#fileinput-demo-2").fileinput({
            'theme': 'explorer-fas',
            'uploadUrl':prefix+ '/upload',
            overwriteInitial: false,
            uploadIcon:"<i class=\"glyphicon glyphicon-upload\"></i>",
            initialPreviewAsData: true,
            uploadAsync:true,
            showCancel:false,
            allowedFileExtensions:['jpg', 'gif', 'png','bmp','jpeg'],//指出带有哪些后缀名的文件才是被接受上传的
            previewFileIcon:'',//当文件无法被预览时出现在缩略图中的图标，默认是
            maxFileCount:10,
            layoutTemplates:{
                actionUpload:""
            },
            deleteExtraData:{
                files:"111111111"
            },
            initialPreview:initialPreview,
            initialPreviewConfig:initialPreviewConfig,




        }).on('filebatchuploaderror', function(event, data, msg) {
            alert("上传失败");
        }).on("filepredelete",function (event,key,jax,data) {
            return !confirm("确定删除？");
        }).on('filedeleted', function(event, key) {
            removearry(ids,key)
            alert("删除成功");

            obj.value=ids;
        });
        $(".kv-file-remove").click(function(){

            alert("target"+JSON.stringify( $(this).target));
        });
        /*$('#fileinput-demo-2').on('filepredelete', function(event,data,jax,key) {
             alert("key"+JSON.stringify(key));
             alert("data"+JSON.stringify(data));
             alert("jax"+JSON.stringify(jax));
             alert("event"+JSON.stringify(event));
             console.log('Key = ' + key);

         });*/


        $("#fileinput-demo-2").on("fileuploaded", function(event, data, previewId, index) {
            alert("data"+JSON.stringify(data));
            initialPreview.push(data.response.initialPreview)
            var obj={
                caption:data.response.filename,
                size:data.response.size,
                url:prefix+ '/delete',
                key:data.response.id,
            }
            alert(JSON.stringify(obj));
            initialPreviewConfig.push(obj);
            alert(JSON.stringify(initialPreview));
            if(ids.length==0){
                ids=data.response.id;
            }else{
                ids=ids+","+data.response.id;
                var idsarry=ids.split(",");
                ids=evlabc(idsarry);
            }
            alert("ids"+ids);
            $("#photoUrl").val(ids);
            alert("obj"+$("#photoUrl").val())
            $('#fileinput-demo-2').fileinput('destroy');
            $("#fileinput-demo-2").fileinput({
                'theme': 'explorer-fas',
                'uploadUrl':prefix+ '/upload',
                overwriteInitial: false,
                uploadIcon:"<i class=\"glyphicon glyphicon-upload\"></i>",
                initialPreviewAsData: true,
                uploadAsync:true,
                showCancel:false,
                allowedFileExtensions:['jpg', 'gif', 'png','bmp','jpeg'],//指出带有哪些后缀名的文件才是被接受上传的
                previewFileIcon:'',//当文件无法被预览时出现在缩略图中的图标，默认是
                maxFileCount:10,
                layoutTemplates:{
                    actionUpload:""
                },
                deleteExtraData:{
                    files:"111111111"
                },
                initialPreview:initialPreview,
                initialPreviewConfig:initialPreviewConfig,




            })
            $('#fileinput-demo-2').fileinput('enable');

        });

        function dianji() {
            alert(initialPreview);
            alert(JSON.stringify(initialPreviewConfig));
            alert($("#photoUrl").val());
        }
        //数组排序方法
        function evlabc(a) { //排序大小
            var i = j = t = 0;
            for (i = 0; i < a.length; i++) {
                for (j = 0; j < a.length; j++) {
                    if (a[i] < a[j]) {// 相邻元素两两对比
                        t = a[i];
                        a[i] = a[j];
                        a[j] = t;
                    }
                }
            }
            return a;
        }
        //取值在数组中的下标
        function indexOfArry (arry,val) {
            for (var i = 0; i < arry.length; i++) {
                if (arry[i] == val) return i;
            }
            return -1;
        };
        //删除数组中固定的值
        function removearry (arry ,val) {
            var index =indexOfArry(arry,val);
            if (index > -1) {
                arry.splice(index, 1);
            }
        };
    });
    </script>
</body>
</html>
