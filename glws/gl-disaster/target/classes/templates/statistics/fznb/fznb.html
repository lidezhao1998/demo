<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('发生防治年报列表')" />
</head>
<style>
    /*修改表头颜色*/
    .table-bordered table thead{
        background-color:rgba(48,146,62, 0.9);
        color: white;
    }

</style>
<body class="gray-bg">
     <div class="container-div">
        <div class="row">
            <div class="col-sm-12 search-collapse">
                <form id="formId">
                    <input type="hidden" id="provinceHidden"/>
                    <input type="hidden" id="cityHidden"/>
                    <div class="select-list">
                        <ul>
                            <!-- <li>
                                 <div id="province">
                                 <label class="col-sm-3 control-label" style="margin-top: 7px">省：</label>
                                 <div class="col-sm-8">
                                     <select id="addrProvince"
                                             style="width: 130px;height: 34px;border:1px solid #e5e6e7"
                                             name="province" onchange="getCities(this.value) "
                                             required="required"></select>
                                 </div>
                                 </div>
                             </li>-->
                            <li>
                                <div id="province">
                                    <em class="i-bit"></em><span>省份：</span>
                                    <select id="addrProvince" name="province" onchange="getCities(this.value)"
                                            style="width: 150px;height:30px; "></select>
                                </div>
                            </li>

                            <li>
                                <div id="city">
                                    <!--  <label class="col-sm-3 control-label" style="margin-top: 7px">市：</label>
                                      <div class="col-sm-8">
                                          <select
                                                  id="addrCity" name="city"
                                                  style="width: 130px;height: 34px;border:1px solid #e5e6e7"
                                                  onchange="getAreas(this.value)" required="required"> </select>
                                      </div>-->
                                    <em class="i-bit"></em><span>市：</span>
                                    <select
                                            id="addrCity" name="city" onchange="getAreas(this.value)"
                                            style="width: 150px;height:30px; ">
                                    </select>
                                </div>
                            </li>
                            <li>
                                <div id="area">
                                    <input id="valuearea" type="hidden"/>
                                    <em class="i-bit"></em><span>县/区：</span>
                                    <select id="addrArea" name="countyLevelName"
                                            style="width: 150px;height:30px; ">
                                    </select>
                                </div>
                            </li>
                            <!--<li>-->
                            <!--<label class="col-sm-3 control-label" style="margin-top: 7px;width: 75px;margin-right: -23px;">县/区：</label>-->
                            <!--<div class="col-sm-8">-->
                            <!--<select id="addrArea" name="countyLevelName"-->
                            <!--style="width: 130px;height: 34px;border:1px solid #e5e6e7"-->
                            <!--onchange="getlngLat()" required="required">-->
                            <!--</select>-->
                            <!--</div>-->
                            <!--</li>-->
                            <li class="select-time">
                                <p>年度：</p>
                                <input type="text" name="year" class="layui-layer-input" placeholder="请选择" id="test2"/>
                            </li>
                            <li>
                                <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i
                                        class="fa fa-search"></i>&nbsp;搜索</a>
                                <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i
                                        class="fa fa-refresh"></i>&nbsp;重置</a>
                            </li>
                        </ul>
                    </div>
                </form>
            </div>

            <div class="btn-group-sm" id="toolbar" role="group">
                <a class="btn btn-warning" onclick="Echars()" >
                    <i class="fa fa-download"></i> 图表展示
                </a>
            </div>
            <div class="col-sm-12 select-table table-bordered">
                <table id="bootstrap-table" class="table table-hover"></table>
            </div>
        </div>
    </div>
    <th:block th:include="include :: footer" />
     <style>
         /* 表格样式 */

         .table>tbody>tr>td {
             border: 0px;
             text-align: center;
         }

         .bootstrap-table .table thead>tr>th {
             text-align: right;
         }

         .table thead {
             background: #ebeaea;
         }
     </style>
    <script th:inline="javascript">
        var editFlag = [[${@permission.hasPermi('zaihai:fznb:edit')}]];
        var removeFlag = [[${@permission.hasPermi('zaihai:fznb:remove')}]];
        var prefix = ctx + "zaihai/fznbtj";

        layui.use('laydate', function () {
            var laydate = layui.laydate;

            //执行一个laydate实例
            laydate.render({
                elem: '#test2'
                , type: 'year'
            });
        });
        $(function() {
            var options = {
                url: prefix + "/list",
                createUrl: prefix + "/add",
                updateUrl: prefix + "/edit/{id}",
                removeUrl: prefix + "/remove",
                exportUrl: prefix + "/export",
                pagination:false,
                showExport: true,
                showSearch: false,
                showToggle: false,
                showColumns: false,
                showRefresh: false,
                modalName: "发生防治年报",
                detailView: false,
                detailFormatter:detailFormatter,
                // showFooter:true,
                onExpandRow: function (index, row, $detail) {
                    if(row.roleName =='区级'){
                    }
                    else if(row.roleName =='市级'){
                        //市级用户查看
                        initChildTable2(index, row, $detail);

                    } else if (row.roleName == '省级'||row.roleName == '省级审核员') {
                        //省级用户查看
                        initChildTable2(index, row, $detail);
                    }else{
                        //国际级用户
                        initChildTable(index, row, $detail);

                    }
                },
                columns: [
                    [

                {
                    rowspan: 3,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle',
                    field : 'year',
                    title : '年份'
                },
                {
                    rowspan: 3,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle',
                    field : 'province',
                    title : '所属省',
                    formatter: function(value, row, index){
                        if(value=='合计'){
                            return "合计";
                        }else{
                            return '<a href="javascript:void(0)" onclick="detailList(\'' + row.province + '\')">' + value + '</a>';
                        }
                    }
                },
                {
                    rowspan: 3,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle',
                    field : 'city',
                    title : '所属市',
                    formatter: function(value,row,index){
                        if(value==null || value==""){
                            return "合计";
                        }else{
                            return '<a href="javascript:void(0)" onclick="cityList(\''+ row.city+ '\')">'+value+'</a>';
                        }
                    }
                },
                {
                    rowspan: 3,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle',
                    field : 'county',
                    title : '所属县'
                },
                    {
                        rowspan: 1,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                        title : '项目类型'
                    },
                        {
                            rowspan: 3,
                            colspan: 1,
                            align: 'center',
                            valign: 'middle',
                            title : '县'
                        },
                    {
                        rowspan: 1,
                        colspan: 4,
                        align: 'center',
                        valign: 'middle',
                        title : '草原虫害防治(万元)'
                    },
                    {
                        rowspan: 1,
                        colspan: 4,
                        align: 'center',
                        valign: 'middle',
                        title : '草原鼠害防治(万元)'
                    },
                    {
                        rowspan: 1,
                        colspan: 2,
                        align: 'center',
                        valign: 'middle',
                        title : '毒害草'
                    },
                    {
                        rowspan: 3,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                        field : 'hazardArea',
                        title : '其中工程区危害面积(万亩)'
                    },
                    {
                        rowspan: 3,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                        field : 'hazardAllArea',
                        title : '危害总面积'
                    },
                    {
                        rowspan: 1,
                        colspan: 2,
                        align: 'center',
                        valign: 'middle',
                        title : '农药'
                    }
                    ],
                    [
                        {
                        rowspan: 2,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                        title : '市(地/州/盟)'
                    },

                        {
                            rowspan: 1,
                            colspan: 4,
                            align: 'center',
                            valign: 'middle',
                            title : '资金配套(万元)'
                        },
                        {
                            rowspan: 1,
                            colspan: 4,
                            align: 'center',
                            valign: 'middle',
                            title : '资金配套(万元)'
                        },

                        {
                            rowspan: 2,
                            colspan: 1,
                            align: 'center',
                            valign: 'middle',
                            field : 'economicLoss',
                            title : '经济损失(万元)'
                        },
                    {
                        rowspan: 2,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                        field : 'livestockDeath',
                        title : '家畜死亡(只/条/个)'
                    },
                        {
                            rowspan: 2,
                            colspan: 1,
                            align: 'center',
                            valign: 'middle',
                            field : 'controlDosage',
                            title : '当年防治用量(亩/量)'
                        },
                        {
                            rowspan: 2,
                            colspan: 1,
                            align: 'center',
                            valign: 'middle',
                            field : 'muDosage',
                            title : '亩用量(亩/量)'
                        }

                      ],
               [{
                    rowspan: 1,
                    colspan: 1,
                    field : 'ratharmCenter',
                    title : '中央'
                },
                {
                    rowspan: 1,
                    colspan: 1,
                    field : 'ratharmProvince',
                    title : '省级'
                },
                {
                    rowspan: 1,
                    colspan: 1,
                    field : 'ratharmCity',
                    title : '地级'
                },
                {
                    rowspan: 1,
                    colspan: 1,
                    field : 'ratharmCounty',
                    title : '县级'
                },
                {
                    rowspan: 1,
                    colspan: 1,
                    field : 'insectharmCenter',
                    title : '中央'
                },
                {
                    rowspan: 1,
                    colspan: 1,
                    field : 'insectharmProvince',
                    title : '省级'
                },
                {
                    rowspan: 1,
                    colspan: 1,
                    field : 'insectharmCity',
                    title : '地级'
                },
                {
                    rowspan: 1,
                    colspan: 1,
                    field : 'insectharmCounty',
                    title : '县级'
                },
                ],
           ],
                onLoadSuccess: function (row) {
                    var roleName= [[${roleName}]];
                    var code = row.rows[0].code;
                    var length= row.rows.length;
                    if (roleName=='国家级') {
                        $('#city').hide();
                        $('#area').hide();
                        $('#bootstrap-table').bootstrapTable('hideColumn', 'city');
                        $('#bootstrap-table').bootstrapTable('hideColumn', 'county');
                        document.getElementById("bootstrap-table").rows[length+2].cells[0].innerHTML="-";
                    }else if(roleName=='省级'){
                        $('#area').hide();
                        if (code!=null &&code!=''){
                            $("#addrProvince").val(code);
                        }
                        getCities(code)
                        $('#province').hide();
                        $('#bootstrap-table').bootstrapTable('hideColumn', 'province');
                        //$('#bootstrap-table').bootstrapTable('hideColumn', 'city');
                        $('#bootstrap-table').bootstrapTable('hideColumn', 'county');
                        document.getElementById("bootstrap-table").rows[length+2].cells[0].innerHTML="-";
                    }else if(roleName=='市级'){
                        row.rows.pop()
                        if (code!=null &&code!=''){
                            $("#addrCity").val(code);
                        }

                        getAreas(code)
                        $('#city').hide();
                        $('#province').hide();
                        $('#bootstrap-table').bootstrapTable('hideColumn', 'province');
                        $('#bootstrap-table').bootstrapTable('hideColumn', 'county');
                    }else if(roleName=='区级'){
                        row.rows.pop()
                        $('#search').hide();
                        $('#bootstrap-table').bootstrapTable('hideColumn', 'city');
                        $('#bootstrap-table').bootstrapTable('hideColumn', 'province');
                    }else if(roleName=='省级审核员'){
                        if (code!=null &&code!=''){
                            $("#addrProvince").val(code);
                        }

                        getCities(code)
                        $('#province').hide();
                        $('#bootstrap-table').bootstrapTable('hideColumn', 'province');

                        //$('#bootstrap-table').bootstrapTable('hideColumn', 'city');
                        $('#bootstrap-table').bootstrapTable('hideColumn', 'county');
                        document.getElementById("bootstrap-table").rows[length+2].cells[0].innerHTML="-";
                    }

                }
            };
            $.table.init(options);
        });
        $(function () {
            getProvinces();
        });

        //子表列表
        initChildTable = function (index, row, $detail) {
            // alert(JSON.stringify(row))
            var province = row.province;
            var cur_table = $detail.html('<div><table style="background:#D3D3D3" ></table></div>').find('table');
            $(cur_table).bootstrapTable({
                url: prefix + "/ParentList",
                method: 'post',
                sidePagination: "server",
                contentType: "application/x-www-form-urlencoded",   // 编码类型
                detailView: true,
                onExpandRow: function (index, row, $detail) {
                    initChildTable2(index, row, $detail);
                },
                queryParams: {
                    province: province,

                },
                columns: [
                    [
                        {


                            align: 'center',
                            valign: 'middle',
                            field : 'year',
                            width:'4%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'city',
                            width:'4.5%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            width:'6%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            width:'1%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field:'ratharmCenter'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field:'ratharmProvince'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'ratharmCity',

                        },
                        {
                            align: 'center',
                            valign: 'middle',
                            field : 'ratharmCounty',

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'insectharmCenter',

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'insectharmProvince',

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'insectharmCity',

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'insectharmCounty',

                        },
                        {
                            align: 'center',
                            valign: 'middle',
                            field : 'economicLoss',
                            width:'6.5%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'livestockDeath',
                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'hazardArea',
                            width:'16.5%'

                        },

                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'hazardAllArea',
                            width:'6.5%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'controlDosage',
                            width:'7.5%'
                        },


                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'muDosage',
                            width:'5%'

                        },
                    ],
                ]
            });
        };
        //三级表列表
        initChildTable2 = function (index, row, $detail) {
            // alert(JSON.stringify(row))
            var city = row.city;
            var cur_table = $detail.html('<div style="padding-left:21px;"><table style="background:#D4F2E7" ></table></div>').find('table');
            $(cur_table).bootstrapTable({
                url: prefix + "/ParentList",
                method: 'post',
                sidePagination: "server",
                contentType: "application/x-www-form-urlencoded",   // 编码类型
                queryParams: {
                    city: city,
                },
                columns: [
                    [
                        {


                            align: 'center',
                            valign: 'middle',
                            field : 'year',
                            width:'4%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'county',
                            width:'4.5%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            width:'6%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            width:'1%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field:'ratharmCenter'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field:'ratharmProvince'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'ratharmCity',

                        },
                        {
                            align: 'center',
                            valign: 'middle',
                            field : 'ratharmCounty',

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'insectharmCenter',

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'insectharmProvince',

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'insectharmCity',

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'insectharmCounty',

                        },
                        {
                            align: 'center',
                            valign: 'middle',
                            field : 'economicLoss',
                            width:'6.5%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'livestockDeath',
                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'hazardArea',
                            width:'16.5%'

                        },

                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'hazardAllArea',
                            width:'6.5%'

                        },
                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'controlDosage',
                            width:'7.5%'
                        },


                        {

                            align: 'center',
                            valign: 'middle',
                            field : 'muDosage',
                            width:'5%'

                        },
                    ],
                ]
            });
        };
        function getProvinces() {
            //  var url = "<%=basePath%>dict/getProvinces";
            var url = ctx + "caiji/survey/getProvinces";
            $.ajax({
                "url": url,
                "type": "GET",
                "dataType": "json",
                "success": function (data) {
                    //alert(JSON.stringify(data))
                    var op = document.createElement("option");
                    op.value = '';
                    op.text = "----- 请选择省 -------";
                    document.getElementById("addrProvince").appendChild(op);
                    for (var i = 0; i < data.length; i++) {
                        var op = document.createElement("option");
                        /*op.value = data[i].dictCode;*/
                        op.value = data[i].dictLabel;
                        op.text = data[i].dictLabel;
                        document.getElementById("addrProvince").appendChild(op);
                    }
                }
            });
            getCities();
        }

        // ===== 加载市列表 =====
        function getCities(value) {
            $("#addrCity").empty();
            $("#addrArea").empty();
            var url = ctx + "caiji/survey/getCities";
            /*var data = "provinceCode=" +$("#addrProvince").val();*/
            var data = "provinceCode=" + value;
            $.ajax({
                "url": url,
                "data": data,
                "type": "GET",
                "dataType": "json",
                "success": function (data) {
                    var op = document.createElement("option");
                    op.value = '';
                    op.text = "----- 请选择市 -------";
                    document.getElementById("addrCity").appendChild(op);
                    for (var i = 0; i < data.length; i++) {
                        var op = document.createElement("option");
                        /*op.value = data[i].dictCode;*/
                        op.value = data[i].dictLabel;
                        op.text = data[i].dictLabel;
                        document.getElementById("addrCity").appendChild(op);
                    }
                }
            });
            getAreas();
            // var op2 = document.createElement("option");
            // op2.value = '';
            // document.getElementById("addrArea").appendChild(op2);
        }
        // ===== 加载区列表 =====
        function getAreas(value) {
            $("#addrArea").empty();
            $("#addrdz").empty();
            //var url = "<%=basePath%>dict/getAreas";
            var url = ctx + "caiji/survey/getAreas";
            /*var data = "cityCode=" +  $("#addrCity").val();*/
            var data = "cityCode=" +  value;
            $.ajax({
                "url": url,
                "data": data,
                "type": "GET",
                "dataType": "json",
                "success": function (data) {
                    var op = document.createElement("option");
                    op.value = '';
                    op.text = "----- 请选择县/区 -------";
                    document.getElementById("addrArea").appendChild(op);
                    for (var i = 0; i < data.length; i++) {
                        var op = document.createElement("option");
                        op.value = data[i].dictCode;
                        op.text = data[i].dictLabel;
                        document.getElementById("addrArea").appendChild(op);
                        $.table
                    }
                }
            });

        }



        function detailFormatter(index, row) {
            return index=== length
        }
        function Echars() {
            var url = prefix + '/Echars';
            $.modal.openFull("防治年报统计图", url);
        }
        function detailViewrow(falg) {

            return falg;
        }
        /** 查询省级详情*/
        function detailList(province) {
            var url = prefix + '/detailList/'+ province;
            $.modal.openTab("区县发生防治年报列表", url);
        }

        /** 查询市级详情 */
        function cityList(city){
            var url = prefix + '/cityList/' + city;
            $.modal.openTab("区县发生防治年报列表", url);
        }

    </script>
</body>
</html>