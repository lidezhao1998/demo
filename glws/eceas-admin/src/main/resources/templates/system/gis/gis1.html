<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>加载天地图</title>
    <th:block th:include="include :: header('地图')"/>
</head>
<body onLoad="onLoad()">
<div>

    <div class="container-div">
        <div class="row">
            <div id="map">
                <div class="header-r">
                    <div class="header-r-bg">
                        <a href="javascript:;" onclick="measurementGis('LineString')">测距</a>
                        <a href="javascript:;" onclick="measurementGis('Polygon')">测面</a>
                        <a href="javascript:;" onclick="drawGis('Grassland','tab')">功能测评</a>
                        <a href="javascript:;" onclick="drawGis('Point','tab')">标记点</a>
                        <a href="javascript:;" onclick="drawGis('Polygon','tab')">标记面</a>
                        <a href="javascript:;" id="waterList">数据查询</a>
                    </div>
                </div>
                <div id="menu">
                    <input type="button" id="off"/>
                </div>
                <div id="menu3">
                    <input id="type3" value="全国" onclick="updateCity()">
                    <span class="glyphicon glyphicon-search" aria-hidden="true"
                          style="cursor: pointer;color: #13c6ae;font-size:18px" onclick="getCityData()"></span>
                </div>
                <div class="layer_tree_show">
                    <div class="layer_tree_show_map"></div>
                </div>
                <div class="layer_tree_hide">
                    <i class="fa fa-chevron-left"></i>
                </div>
                <div class="west">
                    <div class="box box-main">
                        <div class="box-header">
                            <div class="box-title">
                                <i class="fa icon-grid"></i><span style="cursor: pointer;color: #13c6ae;" onclick="serviceTree()" >业务</span>  / <span style="cursor: pointer;color: #43bfac;" onclick="queryDeptTree()"> 专题图层</span>
                            </div>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" id="btnExpand" title="展开" style="display:none;"><i
                                        class="fa fa-chevron-up"></i></button>
                                <button type="button" class="btn btn-box-tool" id="btnCollapse" title="折叠"><i
                                        class="fa fa-chevron-down"></i></button>
                                <button type="button" class="btn btn-box-tool" id="btnRefresh" title="刷新"><i class="fa fa-refresh"></i>
                                </button>
                            </div>
                        </div>
                        <div class="ui-layout-content">
                            <div id="tree" class="ztree"></div>
                        </div>
                    </div>
                </div>
                <div id="dist_positioning">
                    <p id="title_zq"><span>地区定位</span> <span onclick="cityDivDoneById('dist_positioning')" style="float: right;margin: 0 10px;cursor: pointer;">关闭</span></p>
                    <div id="zqdw"><p class="content_ul" style="color: #13c6ae;">全国</p></div>
                    <div style="height: 160px;overflow-y: scroll;float: left;width: 100%">
                        <ul class="zq_ul"></ul>
                    </div>
                </div>
                <div id="shpTitle" class="col-sm-12 select-table table-striped">
                    <table id="bootstrap-table">
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="mouse-position">
    </div>
</div>
<div class="waterList">
    <div class="col-sm-12 select-table table-bordered">
        <form id="formId">
            <div class="row">
                    <!--<div class="select-list">
                        <ul>
                            <li class="select-time">
                                <p>年份：</p>
                                <input type="year" name="year" class="layui-layer-input" placeholder="所有" id="test2" style="margin-top: 0px;" readonly="readonly" />
                            </li>
                            <li>
                            <li>
                                省份：
                                <select id="province" name="province" th:with="type=${@dict.getType('sys_province')}">
                                    <option value="">&#45;&#45;全国&#45;&#45;</option>
                                    <option th:each="dict : ${type}" th:text="${dict.dictLabel}"
                                            th:value="${dict.dictValue}"></option>
                                </select>
                                &nbsp;市级：
                                <select id="city" name="city">
                                    <option value="">&#45;&#45;请选择&#45;&#45;</option>
                                </select>
                                &nbsp;区级：
                                <select id="area" name="address">
                                    <option value="">&#45;&#45;请选择&#45;&#45;</option>
                                </select>
                            </li>
                            </li>
                        </ul>
                    </div>-->
                <button type="button" class="btn btn-primary btn-rounded btn-sm" style="float: right;margin-right: 20px;" onclick="closeReportList()">关闭</button>
               <!-- <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()" style="float: right;margin-right: 10px;"><i class="fa fa-refresh"></i>&nbsp;重置</a>
                <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()" style="float: right;margin-right: 10px;"><i class="fa fa-search"></i>&nbsp;搜索</a>-->
            </div>
        </form>
        <table id="wt"></table>
    </div>
</div>
</body>
<script type="text/javascript">
    var map, spotinfos,vectorDrawing,type="service";
</script>
<th:block th:include="include :: footer"/>
<th:block th:include="include :: layout-latest-css"/>
<th:block th:include="include :: ztree-css"/>
<th:block th:include="include :: layout-latest-js"/>
<th:block th:include="include :: ztree-js"/>
<script type="text/javascript">
    var prefix = ctx + "system/gis";
    var prefixGisFeatures = ctx + "system/gisFeatures";
    var prefixGisTab = ctx + "system/gisTab";
    var reportPrefix = ctx + "system/report";
    var conservationPrefix = ctx + "eceas/conservation";
    function onLoad() {
        load();
    }

    //加载专题数据 点击专题
    function queryDeptTree() {
        type="dept";
        var url = prefixGisFeatures + "/getList/1";
        var options = {
            url: url,
            expandLevel: 2,
            check: {enable: true},
            onCheck: zOnClick
        };
        $.tree.init(options);

        function zOnClick(event, tree) {
            var count = map.getLayers().getLength();
            if (count != 2) {
                for (var i = count - 1; i > 1; i--) {
                    map.removeLayer(map.getLayers().item(i));
                }
            }
            var ids = $.tree.getCheckedNodes();
            if (ids != undefined && ids != null && ids != '') {
                $.post(prefix + "/getSpot",
                    {shpIds: ids}, function (res) {
                        for (var i = 0; i < res.data.length; i++) {
                            var type="project_type='" + res.data[i].id + "'";
                            loadgis(type,gisMapName);
                        }
                    })
            }else{
                ol.Observable.unByKey(mapClick);
            }
        }

    }

    //加载业务图层 点击事件
    function serviceTree() {
        type="service";
        var url = prefixGisFeatures + "/getList/2";
        var options = {
            url: url,
            expandLevel: 2,
            check: {enable: true},
            onCheck: zOnClick
        };
        $.tree.init(options);

        function zOnClick(event, tree) {
            var count = map.getLayers().getLength();
            if (count != 2) {
                for (var i = count - 1; i > 1; i--) {
                    map.removeLayer(map.getLayers().item(i));
                }
            }
            var ids = $.tree.getCheckedNodes();
            if (ids != undefined && ids != null && ids != '') {
                $.post(prefix + "/getSpot",
                    {shpIds: ids}, function (res) {
                        for (var i = 0; i < res.data.length; i++) {
                            shpInfo(res.data[i]);
                        }
                    })
            }
            else{
                ol.Observable.unByKey(mapClick);
            }
        }
    }

    $('#btnExpand').click(function () {
        $._tree.expandAll(true);
        $(this).hide();
        $('#btnCollapse').show();
    });
    $('#btnRefresh').click(function () {
        queryDeptTree();
    });

    $('#btnCollapse').click(function () {
        $._tree.expandAll(false);
        $(this).hide();
        $('#btnExpand').show();
    });

    function updateCity() {
        $.get(prefix + "/getDistrictSheng",
            function (res) {
                if (vectorDrawing != null) {
                    map.removeLayer(vectorDrawing);
                }
                var cityHtml = "";
                for (var i = 0; i < res.length; i++) {
                    cityHtml += "<li onclick='getSheng(" + res[i].id + ")'>" + res[i].cityName + "</li>";
                }
                $(".zq_ul").text("");
                $(".zq_ul").append(cityHtml);
                $("#type3").val('全国');
                $(".content_ul").html('全国');
                $("#dist_positioning").show();
            })
    }

    function getSheng(id) {
        var view = map.getView();
        $.get(prefix + "/getDistrictShi/" + id, function (res) {
            var cityHtml = "";
            for (var i = 0; i < res.citys.length; i++) {
                cityHtml += "<li onclick='getShi(" + res.citys[i].id + ")'>" + res.citys[i].cityName + "</li>";
            }
            var cityHtm = "<span style='cursor: pointer' onclick='updateCity()'>全国</span> <span style='cursor: pointer;color: #43bfac;' onclick='getSheng(" + res.city.id + ")'> > " + res.city.cityName + "</span>";
            $(".content_ul").html(cityHtm);
            $(".zq_ul").text("");
            $(".zq_ul").append(cityHtml);
            $("#dist_positioning").show();
            var can = res.city.canter.split(",");
            view.setCenter([parseFloat(can[0]), parseFloat(can[1])]);
            view.setZoom(7)
            $("#type3").val(res.city.cityName);
            plotCity(res.city.cityName, "name='" + res.city.cityName + "'", res.city.id, "division");
        })
    }

    function getShi(id) {
        var view = map.getView();
        $.get(prefix + "/getDistrictQu/" + id, function (res) {
            $(".zq_ul").text("");
            var cityHtml = "";
            if (res.citys != null) {
                for (var i = 0; i < res.citys.length; i++) {
                    cityHtml += "<li onclick='getQu(" + res.citys[i].id + ")'>" + res.citys[i].cityName + "</li>";
                }
                $(".zq_ul").append(cityHtml);
            }
            var cityHtm = "<span style='cursor: pointer' onclick='getShi('" + res.city.id + "')'> > " + res.city.cityName + "</span>";
            $(".content_ul").append(cityHtm);
            $("#dist_positioning").show();
            var can = res.city.canter.split(",");
            view.setCenter([parseFloat(can[0]), parseFloat(can[1])]);
            view.setZoom(7)
            $("#type3").val(res.city.cityName);
            plotCity(res.city.cityName, "CityNameC ='" + res.city.cityName + "'", res.city.id, "shi");
        })
    }

    function getQu(id) {
        var view = map.getView();
        $.get(prefix + "/getDistrictById/" + id, function (res) {
            var cityHtml = "";
            $(".zq_ul").text("");
            if (res.citys != null) {
                var cityHtml = "";
                for (var i = 0; i < res.citys.length; i++) {
                    cityHtml += "<li>" + res.citys[i].cityName + "</li>";
                }
                $(".zq_ul").append(cityHtml);
            }
            $("#dist_positioning").show();

            var can = res.city.canter.split(",");
            view.setCenter([parseFloat(can[0]), parseFloat(can[1])]);
            view.setZoom(7)
            $("#type3").val(res.city.cityName);
            plotCity(res.city.cityName, "name='" + res.city.cityName + "'", res.city.id, "qu");
        })
    }

    function cityDivDoneById(name) {
        var newNam = "#" + name;
        $(newNam).hide();
        $("#type3").val('全国');
        if (vectorDrawing != null) {
            map.removeLayer(vectorDrawing);
        }

    }
    //加载各省有多少草数据
    function getCityData() {
        var cityName = $("#type3").val();
        if(type=="dept"){
            //根据地区查询数据库
        }else{
            if (cityName == '全国') {
                return;
            }
            var cql = "CQL_FILTER=cityName='" + cityName + "'";
            var url =gisUrl + cityUrlData + cql;
            $.getJSON(url,function (res) {
                var featuresData = res.features;
                var resData = [];
                for (var i = 0; i < featuresData.length; i++) {
                    resData.push(featuresData[i].properties);
                }
                var options = {
                    data: resData,
                    columns: [
                        {
                            field: 'cityName',
                            title: '地区'
                        },
                        {
                            field: '目',
                            title: '目'
                        },
                        {
                            field: '科',
                            title: '科'
                        },
                        {
                            field: '属',
                            title: '属'
                        },
                        {
                            field: '丛',
                            title: '丛'
                        },
                        {
                            field: 'F_AREA',
                            title: '占地面积(km²)',
                            formatter: function (value, row, index){
                                return row.F_AREA /1000000;
                            }
                        },

                    ]
                }
                $("#shpTitle").show();
                $.table.init(options);
            })

        }

    }

    $(function () {
        var panehHidden = false;
        if ($(this).width() < 769) {
            panehHidden = true;
        }
//        $('body').layout({initClosed: panehHidden, west__size: 185});
        serviceTree();
    });

    $('.layer_tree_show_map').on('click',function () {
        $('.west').show();
        $('.layer_tree_hide').show();
    });

    $('.layer_tree_hide i').on('click',function () {
        $('.west').hide();
        $('.layer_tree_hide').hide();
    });

    /** 涵养水源功能评估数据查询 */
    $("#waterList").click(function(){
        debugger;
        let options = {
            id:"wt",
            url: conservationPrefix+"/list",
            modalName: "涵养水源数据汇总",
            striped: false,
            bordered: false,
            pagination:true,
            showSearch: false,
            showToggle: false,
            showColumns: false,
            showRefresh: false,
            pageSize:[5],
            pageList: [5, 10],
            /*onClickRow: onClickRowMark,*/
            columns: [
                [
                    {
                        field: 'index',
                        title: '序号',
                        rowspan: 1,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                        formatter: function(value, row, index){
                            return index + 1;
                        }
                    },
                    {
                        field: 'address',
                        title: '地区',
                        rowspan: 1,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                        visible: false
                    },
                    {
                        field : 'area',
                        title : '面积(单位：万km²）',
                        rowspan: 1,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                    },
                    {
                        field: 'createBy',
                        title: '评价人',
                        rowspan: 1,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                    },
                    {
                        field: 'createTime',
                        title: '创建时间',
                        rowspan: 1,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                    },
                    {
                        field : 'waterconservation',
                        title : '年涵养水源量(单位：m3)',
                        rowspan: 1,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                        border: 1,
                    },
                    {
                        field : 'conservewatervalue',
                        title : '涵养水源价值(单位：元)',
                        rowspan: 1,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                        border: 1,
                    },
                    {
                        field : 'ecologyType',
                        title : '生态类型',
                        rowspan: 1,
                        colspan: 1,
                        align: 'center',
                        valign: 'middle',
                        border: 1,
                    },
                ],
            ]
        };
        $.table.init(options);
        $('.waterList').show();
        $('#wt').show();
    });

    /* 关闭上报信息列表 */
    function closeReportList() {
        $('.waterList').hide();
    }

    /* 单击行定位上报图层 */
    function onClickRow(row, $element){
        alert("单击行mapId：" + row.mapId);
        $.get(prefixGisTab+"/getTabById?id="+row.mapId,function (res) {
            if(res!=null && res!=""){
                loadgisByMapId(res.id,res.centre);
            }else{
                layer.msg("当前数据未绑定图层.",{icon: 6, time: 3000});
            }
        })
    }

    /* 标记列表 单击行定位上报图层 */
    function onClickRowMark(row, $element){
        loadgisByTabId(res.id,res.centre);
    }

    function onClickCell(field, value, row, $element){
        //alert("单击格name：" + field + " value：" + value);
    }

    layui.use('laydate', function () {
        var laydate = layui.laydate;
        //执行一个laydate实例
        laydate.render({
            elem: '#test2'
            , type: 'year'
        });
    });

    /* 省市区三级联动 */
    // ===== 切换省份 =====
    $("#province").change(function () {
        let provinceCode = $('#province option:selected').val();
        $("#city").empty();
        $("#area").empty();
        //获取所属市级
        getCitiess(provinceCode);
    });
    // ===== 切换市级 =====
    $("#city").change(function () {
        let cityCode = $('#city option:selected').val();
        $("#area").empty();
        //获取区县级
        getAreass(cityCode);
    });

    // ===== 加载市列表 =====
    function getCitiess(provinceCode) {
        var url = ctx + "system/analysis/getCities";
        $.ajax({
            "url": url,
            "data": {"provinceCode": provinceCode},
            "type": "post",
            "dataType": "json",
            "success": function (data) {
                var op = document.createElement("option");
                op.value = '';
                op.text = "-- 请选择地址 --";
                document.getElementById("city").appendChild(op);
                let cityHtml = '';
                for (var i = 0; i < data.length; i++) {
                    var op = document.createElement("option");
                    op.value = data[i].dictCode;
                    op.text = data[i].dictLabel;
                    document.getElementById("city").appendChild(op);
                    cityHtml += '<li dictCode="' + data[i].dictCode + '">' + data[i].dictLabel + '</li>';
                }
                $('#sel_city').html(cityHtml);
            }
        });
        var op2 = document.createElement("option");
        op2.value = '';
        op2.text = "-- 请选择地址 --";
        document.getElementById("area").appendChild(op2);
        $('#sel_area').html('');
    }

    // ===== 加载区列表 =====
    function getAreass(cityCode) {
        var url = ctx + "system/analysis/getAreas";
        $.ajax({
            "url": url,
            "data": {"cityCode": cityCode},
            "type": "post",
            "dataType": "json",
            "success": function (data) {
                var op = document.createElement("option");
                op.value = '';
                op.text = "-- 请选择地址 --";
                document.getElementById("area").appendChild(op);
                let areaHtml = '';
                for (var i = 0; i < data.length; i++) {
                    var op = document.createElement("option");
                    op.value = data[i].dictCode;
                    op.text = data[i].dictLabel;
                    document.getElementById("area").appendChild(op);
                    areaHtml += '<li dictCode="' + data[i].dictCode + '">' + data[i].dictLabel + '</li>';
                }
                $('#sel_area').html(areaHtml);
            }
        });
    }

    /* 省市区三级联动end */
</script>
<style type="text/css">
    body, html {
        width: 100%;
        height: 100%;
        margin: 0;
        font-family: "微软雅黑";
    }
    #map {
        height: 100%;
        width: 100%;
    }
    #savaInput {
        float: right;
        margin-top: 0px;
        padding-top: 0px;
        padding-bottom: 0px;
    }
    #menu {
        float: right;
        position: absolute;
        right: 50%;
        z-index: 2000;
    }
    #zqdw {
        float: left;
        width: 100%;
    }
    #dist_positioning {
        position: absolute;
        z-index: 10;
        top: 6%;
        width: 380px;
        min-height: 50px;
        background: #fff;
        box-shadow: 0 1px 10px 1px #ccc;
        display: none;
        left: 30px;
    }
    #shpTitle{
        height: 250px;
        bottom: 3px;
        position: absolute;
        z-index: 2001;
        display: none;
    }
    #dist_positioning ul{
        padding: 0px;
    }
    #dist_positioning ul li {
        float: left;
        width: 90px;
        min-width: 90px;
        text-align: center;
        line-height: 25px;
        padding: 0 8px;
        margin: 2px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid #efefef;
        word-break: keep-all;
        list-style: none;
    }
    #dist_positioning ul li:hover {
        background-color: #19aa8d;
        color:  white;
    }
    #menu3 {
        float: left;
        position: absolute;
        bottom: 95%;
        left: 30px;
        z-index: 2000;
    }
    input, b {
        margin-left: 5px;
        font-size: 14px
    }
    input {
        margin-top: 10px;
        margin-left: 5px;
        font-size: 14px;
        text-align: center;
    }
    /* 鼠标位置控件层样式设置 */
    #mouse-position {
        float: right;
        position: absolute;
        left: 40%;
        bottom: 5px;
        width: 200px;
        height: 20px;
        /*在地图容器中的层，要设置z-index的值让其显示在地图上层*/
        z-index: 2000;
    }
    #dist_positioning p {
        width: 100%;
        height: 35px;
        line-height: 35px;
        padding-left: 20px;
        font-size: 14px;
        background: #f7f7f7;
    }
    #zqdw .content_ul {
        width: auto;
        min-width: 50px;
        height: 30px;
        line-height: 30px;
        font-size: 12px;
    }
    /* 鼠标位置信息自定义样式设置 */
    .custom-mouse-position {
        color: rgb(0,0,0);
        font-size: 18px;
        font-family: "微软雅黑";
    }
    /**
   * 提示框的样式信息
   */
    .tooltip {
        position: relative;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
        color: white;
        padding: 4px 8px;
        opacity: 0.7;
        white-space: nowrap;
    }

    .tooltip-measure {
        opacity: 1;
        font-weight: bold;
    }

    .tooltip-static {
        background-color: #ffcc33;
        color: black;
        border: 1px solid white;
    }

    .tooltip-measure:before,
    .tooltip-static:before {
        border-top: 6px solid rgba(0, 0, 0, 0.5);
        border-right: 6px solid transparent;
        border-left: 6px solid transparent;
        content: "";
        position: absolute;
        bottom: -6px;
        margin-left: -7px;
        left: 50%;
    }

    .west{
        position: absolute;
        margin: 0px;
        left: 36px;
        right: auto;
        top: 50px;
        bottom: 0px;
        height: 568px;
        z-index: 1;
        overflow: hidden;
        width: 185px;
        display: none;
        visibility: visible;
    }
    .layer_tree_show{
        position: absolute;
        width: 50px;
        height: 50px;
        left: 36px;
        right: auto;
        top: 50px;
        bottom: 0px;
        z-index: 1;
        font-size: 25px;
        color: #19aa8d;
        cursor: pointer;
    }
    .layer_tree_hide{
        position: absolute;
        width: 20px;
        height: 45px;
        left: 221px;
        right: auto;
        top: 50px;
        bottom: 0px;
        z-index: 1;
        font-size: 14px;
        color: #19aa8d;
        background-color: #ececec;
        padding-top: 10px;
        cursor: pointer;
        display: none;
    }
    .layer_tree_hide i{
        padding: 4px;
    }
    .header-r {
        position: absolute;
        z-index: 2;
        height: 40px;
        padding-left: 10px;
        background: #fff;
        background-size: 100%;
        padding-right: 10px;
        right: 20px;
        top: 6px;
        border-radius: 3px;
    }
    .header-r .header-r-bg {
        margin-top: 5px;
        display: inline-block;
        padding: 0 5px;
        background: #fff;
        border-radius: 20px;
    }
    .header-r a {
        position: relative;
        display: inline-block;
        height: 30px;
        line-height: 30px;
        color: #000;
        font-size: 14px;
        padding: 0 10px 0 20px;
    }
    .header-r a:hover {
        text-decoration: none !important;
        color: #ff6600;
    }
    .layer_tree_show_map{
        position: absolute;
        width: 32px;
        height: 32px;
        z-index: 2;
        background: url(../../img/icon-map-dq.png) no-repeat center;
    }
    #off{
        border: 0px;
        cursor: pointer;
        color: #13c6ae;
        font-size: 16px;
        display: none;
        background-color: white;
        width: 100px;
        height: 36px;
        border-radius: 16px;
        outline: none;
    }

    /** 涵养水源数据表 */
    .waterList{
        position: absolute;
        margin: 0px;
        top: auto;
        bottom: 0px;
        left: 0px;
        right: 0px;
        width: auto;
        z-index: 0;
        display: none;
        visibility: visible;
    }
</style>
</html>
