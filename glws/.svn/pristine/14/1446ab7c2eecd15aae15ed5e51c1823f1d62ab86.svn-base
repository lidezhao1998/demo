<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('国土空间')"/>
    <link th:href="@{/css/gis.css}" rel="stylesheet"/>
</head>
<body class="gray-bg" onload="onLoad()">
<div id="map" style="height: 300px">
    <div class="header-r">
        <div class="header-r-bg">
            <strong></strong><a href="javascript:;" style="font-size: 16px;color:red" id="gisZoom"></a></strong>
            <a href="javascript:;" id="comparison" onclick="comparison()">比对</a>
            <a href="javascript:;" id="ranging" onclick="measurementGis('LineString')">测距</a>
            <a href="javascript:;" id="measuringSurface" onclick="measurementGis('Polygon')">测面</a>
            <a href="javascript:;" id="markPoint" onclick="drawGis('Point','tab')">标记点</a>
            <a href="javascript:;" id="markingSurface" onclick="drawGis('Polygon','tab')">标记面</a>
            <a href="javascript:;" id="markedList">标记列表</a>
            <a href="javascript:;" id="pointSerch" onclick="pointQuery()">点查</a>
            <a href="javascript:;" id="locationShow">定位</a>
            <a href="javascript:;" id="conditionQuery">条件查询</a>
            <div class="conditionQuery_sel" style="display: none">
                <div class="triangle"></div>
                <a href="javascript:;" id="business">业务查询</a>
                <a href="javascript:;" id="special">专题查询</a>
            </div>
        </div>
    </div>
    <div id="menu">
        <input type="button" id="off"/>
    </div>
    <div id="menu3" style="left: 32px">
        <input id="type3" value="全国" onclick="updateCity()"readonly>
    </div>
    <div class="layer_tree_show">
        <div class="layer_tree_show_map"></div>
    </div>
    <div class="layer_tree_hide">
        <i class="fa fa-chevron-left"></i>
    </div>
    <div class="west">
        <div class="box box-main">
            <div class="ui-layout-content" style="height: 420px">
                <div id="businessLayer" class="ztree" style="overflow-x: scroll;height: 200px;"></div>
                <div id="thematicLayer" class="ztree" style="overflow-x: scroll;height: 200px;"></div>
            </div>
        </div>
    </div>
    <div id="dist_positioning">
        <p id="title_zq"><span>地区定位</span> <span onclick="cityDivDoneById('dist_positioning')"
                                                 style="float: right;margin: 0 10px;cursor: pointer;">关闭</span>
        </p>
        <div id="zqdw"><p class="content_ul" style="color: #13c6ae;">全国</p></div>
        <ul class="zq_ul"></ul>
    </div>
    <div id="shpTitle" class="col-sm-12 select-table table-striped">
        <table id="bootstrap-table">
        </table>
    </div>
    <!--定位-->
    <div class="coordinatePositioning">
        <li class="clear li-dw selected" style="display: block;">
            <span class="zs-left icon icon-dw"></span>
            <div class="zs-left module" style="display: block;">

                <div class="ori-module-content module-content" style="display: block;padding-left: 50px;">
                    <table class="jwd tabls" style="display: table;">
                                     <tr>
                                        <td class="text">经度：</td>
                                        <td class="input"><input id="decimalLon" value="" class="form-control sea-input"  placeholder="例:11.1" onkeyup="value=value.replace(/^\D*(\d*(?:\.\d{0,2})?).*$/g, '$1')"></td>
                                    </tr>
                                    <tr>
                                        <td class="text">纬度：</td>
                                        <td class="input"><input id="decimalLat" value="" class="form-control sea-input" placeholder="例:23.1" onkeyup="value=value.replace(/^\D*(\d*(?:\.\d{0,2})?).*$/g, '$1')"></td>
                                    </tr>
                    </table>
                    <div class="dw-box" style="margin-top: 15px;">
                        <button type="button" class="btn btn-primary" id="positioning_btn">定位</button>
                        <button type="button" class="btn btn-danger" id="closePositioning">关闭</button>
                    </div>
                </div>
            </div>
        </li>
        <div id="mouse-position">
        </div>
    </div>
</div>
<div id="map-left" style="display: none">
    <div class="layer_tree_show">
        <div class="layer_tree_show_map_left"></div>
    </div>
    <div class="layer_tree_hide_left">
        <i class="fa fa-chevron-left"></i>
    </div>
    <div class="west-left">
        <div class="box box-main">
            <div class="ui-layout-content" style="height: 420px">
                <div id="businessLayer_left" class="ztree" style="overflow-x: scroll;height: 200px;"></div>
                <div id="thematicLayer_left" class="ztree" style="overflow-x: scroll;height: 200px;"></div>
            </div>
        </div>
    </div>
</div>
<div id="map-right" style="display: none">
    <div class="header-r">
        <div class="header-r-bg">
            <a href="javascript:;" id="gisQuit" onclick="gisQuit()">退出</a>
        </div>
    </div>
    <div class="layer_tree_show">
        <div class="layer_tree_show_map_right"></div>
    </div>
    <div class="layer_tree_hide_right">
        <i class="fa fa-chevron-left"></i>
    </div>
    <div class="west-right">
        <div class="box box-main">
            <div class="ui-layout-content" style="height: 420px">
                <div id="businessLayer_right" class="ztree" style="overflow-x: scroll;height: 200px;"></div>
                <div id="thematicLayer_right" class="ztree" style="overflow-x: scroll;height: 200px;"></div>
            </div>
        </div>
    </div>
</div>
</div>
<div class="row">
    <div class="col-sm-12">
            <div class="tab-content" style="width: 100%;height: 100%;">
                <div id="tab-1" class="tab-pane active">

                    <div class="panel-body" style="padding: 5px;">
                        <div class="container-div">

                            <div class="row">
                                <div class="col-sm-12 search-collapse">
                                    <form id="dept-form">
                                        <div class="select-list">
                                            <ul>
                                                <li>
                                                    目：<input type="text" name="item" style="width: 100px;"/>
                                                </li>
                                                <li>
                                                    科：<input type="text" name="section" style="width: 100px;"/>
                                                </li>
                                                <li>
                                                    属：<input type="text" name="generic" style="width: 100px;"/>
                                                </li>
                                                <li>
                                                    从：<input type="text" name="bundle" style="width: 100px;"/>
                                                </li>
                                                <li>
                                                    状态：
                                                    <select name="status" id="status" style="width: 100px;">
                                                        <option value="-1">所有</option>
                                                        <option value="0">未审核</option>
                                                        <option value="1">已审核</option>
                                                    </select>
                                                </li>
                                                <li>
                                                    <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search('dept-form','slsj')"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                                    <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset('dept-form','slsj')"><i class="fa fa-refresh"></i>&nbsp;重置</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </form>
                                </div>

                                <div class="btn-group-sm" id="shptoolbar" role="group">
                                    <!--<a class="btn btn-success" onclick="$.operate.add(100)" shiro:hasPermission="system:shpFile:add">-->
                                    <!--<i class="fa fa-plus"></i> 新增-->
                                    <!--</a>-->
                                   <!-- <a class="btn btn-success" onclick="$.operate.add(100)" shiro:hasPermission="system:shpFile:add">
                                        <i class="fa fa-upload"></i> 导入
                                    </a>-->
                                </div>
                                <div class="col-sm-12 select-table table-striped">
                                    <table id="slsj"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-2" class="tab-pane">
                    <div class="panel-body">
                        <div class="container-div">
                            <div class="row">
                                <div class="col-sm-12 search-collapse">
                                    <form id="remotesensing-form">
                                        <div class="select-list">
                                            <ul>
                                                <li>
                                                    名称：<input type="text" name="name"/>
                                                </li>
                                                <li>
                                                    <a class="btn btn-primary btn-rounded btn-sm"
                                                       onclick="$.table.search('remotesensing-form','remotesensing-table')"><i
                                                            class="fa fa-search"></i>&nbsp;搜索</a>
                                                    <a class="btn btn-warning btn-rounded btn-sm"
                                                       onclick="$.form.reset('remotesensing-form','remotesensing-table')"><i
                                                            class="fa fa-refresh"></i>&nbsp;重置</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </form>
                                </div>

                                <div class="btn-group-sm" id="remotesensing_toolbar" role="group">
                                    <!--<a class="btn btn-success" onclick="$.operate.add()"-->
                                    <!--shiro:hasPermission="integration:remotesensing:add">-->
                                    <!--<i class="fa fa-plus"></i> 新增-->
                                    <!--</a>-->
                                    <!--<a class="btn btn-danger multiple disabled" onclick="$.operate.removeAll()"-->
                                    <!--shiro:hasPermission="integration:remotesensing:remove">-->
                                    <!--<i class="fa fa-remove"></i> 批量删除-->
                                    <!--</a>-->
                                    <a class="btn btn-warning multiple disabled" onclick="auditAll()" shiro:hasPermission="integration:recoveryquestion:edit">
                                        <i class="fa fa-download"></i> 批量审核
                                    </a>
                                </div>
                                <div class="col-sm-12 select-table table-striped">
                                    <table id="remotesensing-table"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</div>

<div class="modal inmodal" id="myModal" align="center" tabindex="-1" role="dialog" aria-hidden="true">
    <img id="img" name="img">
</div>
<th:block th:include="include :: footer"/>
<th:block th:include="include :: ztree-js"/>
<th:block th:include="include :: ztree-css"/>
<script th:src="@{/js/gis/glmaGis.js}"></script>
<script th:src="@{/js/gis/gisComparison.js}"></script>
<script type="text/javascript" src="http://api.tianditu.gov.cn/api?v=4.0&tk=3defde9e465f739e73513ce9e8595fe3"></script>
<script th:inline="javascript">
    var spatialPlanningPrefix = ctx + "extinterface/spatialPlanning";
    $(function () {
        var aaaoptions = {
            id: "slsj",
            toolbar: "shptoolbar",
            url: spatialPlanningPrefix+"/list",
            createUrl: spatialPlanningPrefix + "/add/",
            updateUrl: spatialPlanningPrefix + "/edit/{id}",
            removeUrl: spatialPlanningPrefix + "/remove/{id}",
            importUrl: spatialPlanningPrefix + "/importData",
            modalName: "shp文件",
            detailUrl: spatialPlanningPrefix + "/detail/{id}",
            pageSize:3,
            pageList:[5,10,20,50,100],//分页步进值
            showSearch: false,
            showToggle: false,
            showColumns: false,
            showRefresh: false,
            columns: [{
                checkbox: true,
                formatter:  function (value, row, index) {
                    if (row.status == '1'){
                        return {
                            disabled : true//设置是否可用
                        };
                    }
                }
            },
                {
                    field: 'id',
                    title: 'ID'
                },
                {
                    field: 'item',
                    title: '目'
                },
                {
                    field: 'section',
                    title: '科'
                },
                {
                    field: 'generic',
                    title: '属'
                },
                {
                    field: 'bundle',
                    title: '丛'
                },
                {
                    field: 'provinceName',
                    title: '分布范围'
                },
                {
                    field: 'area',
                    title: '面积(平方米)'
                },
                {
                    field: 'status',
                    title: '状态',
                    formatter: function (value, row, index) {
                        if(value=='1'){
                            return "已审核";
                        }else{
                            return "未审核";
                        }
                    }
                },
                {
                    title: '操作',
                    align: 'left',
                    formatter: function (value, row, index) {
                        if (row.parentId != 0) {
                            var actions = [];
                            // actions.push('<a class="btn btn-info  btn-xs " href="javascript:void(0)" onclick="$.operate.add(\'' + row.shpFileId + '\')"><i class="fa fa-plus"></i>新增</a> ');
                            actions.push('<a class="btn btn-info  btn-xs " href="javascript:void(0)" onclick="shpInfoLayer(' + row.id + ',\''+row.geomData+'\')"><i class="fa fa-search"></i>查看</a> ');
                            if(row.status!='1'){
                                // actions.push('<a class="btn btn-success btn-xs " href="javascript:void(0)" onclick="$.operate.edit(\'' + row.shpFileId + '\')"><i class="fa fa-edit"></i>编辑</a> ');
                                actions.push('<a class="btn btn-warning btn-xs" href="javascript:void(0)" onclick="examine(\'' + row.id + '\')"><i class="fa fa-adjust"></i>审核通过</a>');
                                actions.push('<a class="btn btn-success btn-xs " href="javascript:void(0)" onclick="$.operate.edit(\'' + row.id + '\')"><i class="fa fa-edit"></i>编辑</a> ');
                                actions.push('<a class="btn btn-danger btn-xs " href="javascript:void(0)" onclick="$.operate.remove(\'' + row.id + '\')"><i class="fa fa-trash"></i>删除</a>');
                            }else{
                                actions.push('<a class="btn btn-warning btn-xs" href="javascript:void(0)" onclick="unexamine(\'' + row.id + '\')"><i class="fa fa-blind"></i>驳回审核</a>');
                            }
                            return actions.join('');
                        } else {
                            return "";
                        }
                    }
                }]
        };
        $.table.init(aaaoptions);
    });
    function examine(id) {
        var data={"id":id}
        $.modal.confirm("确定审核通过吗？", function() {
            $.ajax({
                type: "post",
                url: spatialPlanningPrefix + "/examine",
                data: data,
                success: function (res) {
                    $.table.refresh();
                    $.operate.ajaxSuccess(res)
                }
            });
        })
    }
    function unexamine(id) {
        var data={"id":id}
        $.modal.confirm("确定取消审核吗？", function() {
            $.ajax({
                type: "post",
                async:false,
                url: spatialPlanningPrefix + "/unexamine",
                data: data,
                success: function (res) {
                    $.table.refresh();
                    $.operate.ajaxSuccess(res)
                }
            });
        })
    }



    function auditAll() {
        var ids=$("#remotesensing-table").bootstrapTable("getAllSelections")
        if (ids.length == 0) {
            $.modal.alertWarning("请至少选择一条记录");
            return;
        }
        $.modal.confirm("确定要审核通过" + ids.length + "条数据吗?", function() {
            var data="0";
            for(var i=0;i<ids.length;i++){
                data+=","+ids[i].id
            }
            $.operate.post(remotesensingPrefix + "/auditAll",{"ids":data});
        });
    }
    function unaudit(id) {
        $.modal.confirm("确定取消审核吗？", function() {
            $.operate.post(remotesensingPrefix + "/unaudit", {"id": id });
        })
    }
    function examine(id) {
        $.modal.confirm("确定审核通过吗？", function() {
            $.operate.post(spatialPlanningPrefix + "/examine", {"id": id });
        })
    }
    function unexamine(id) {
        $.modal.confirm("确定取消审核吗？", function() {
            $.operate.post(spatialPlanningPrefix + "/unexamine", {"id": id });
        })
    }
    function auditAllshp() {
        var ids=$("#slsj").bootstrapTable("getAllSelections")
        if (ids.length == 0) {
            $.modal.alertWarning("请至少选择一条记录");
            return;
        }
        $.modal.confirm("确定要审核通过" + ids.length + "条数据吗?", function() {
            var data="0";
            for(var i=0;i<ids.length;i++){
                data+=","+ids[i].shpFileId
            }
            $.operate.post(aaaa + "/auditAllShp",{"ids":data});
        });
    }
    function show(url){
        if (vectorDrawing != null) {
            map.removeLayer(vectorDrawing);
        }
        $.post(remotesensingPrefix+"/gisShow",{url:url},
            function(res) {
                gisShow(res);
            }
        )
    }
    function shpInfoLayer(id,geomData) {
        var count = map.getLayers().getLength();
        if (count != 2) {
            for (var i = count - 1; i > 1; i--) {
                map.removeLayer(map.getLayers().item(i));
            }
        }
        var cql="id=" + id;
        var tiled = new ol.layer.Tile({
            source: new ol.source.TileWMS({
                url: gisUrl + urlPostLayer,
                params: {
                    FORMAT: 'image/png',
                    VERSION: '1.1.1',
                    tiled: true,
                    exceptions: 'application/vnd.ogc.se_inimage',
                    LAYERS:"postgis:government_land",
                    CQL_FILTER: cql
                }
            })
        });
        map.addLayer(tiled);
        pointLocation(geomData);
    }
    function gisShow(data) {

        var datashp=[];
        for(var i=0;i<data.length;i++){
            var dataShpArray=[];
            var dataWipeOffArray=[];
            var dataList=data[i];
            if(dataList.shpList!=null){
                var dataShpValue=dataList.shpList[0];
                for(var n=0;n<dataShpValue.length;n++){
                    var array=[];
                    var datas=  dataShpValue[n] .split(" ");
                    array.push(datas[0].substring(0,8),datas[1].substring(0,8));
                    dataShpArray.push(array);
                }
                if(dataShpArray.length>0){
                    datashp.push(dataShpArray);
                }
            }
            if(dataList.wipeOffList!='[]' && dataList.wipeOffList!=''){
                var dataShpwipeOffValue=dataList.wipeOffList[0];
                for(var n=0;n>dataShpwipeOffValue.length;n++){
                    var array=[];
                    var datas=  dataShpwipeOffValue[n] .split(" ");
                    array.push(datas[0].substring(0,8),datas[1].substring(0,8));
                    dataShpArray.push(array);
                }
                if(dataWipeOffArray.length>0){
                    datashp.push(dataWipeOffArray);
                }
            }
        }
        console.log(datashp)
        var polygon = new ol.Feature({
            geometry: new ol.geom.Polygon(datashp)
        });
        polygon.setStyle(new ol.style.Style({
            //填充色
            fill: new ol.style.Fill({
                color: 'rgba(255, 255, 255, 0.5)'
            }),
            //边线颜色
            stroke: new ol.style.Stroke({
                color: 'red',
                width: 2
            }),
            //形状
            image: new ol.style.Circle({
                radius: 1,
                fill: new ol.style.Fill({
                    color: 'red'
                })
            })
        }));
        //实例化一个矢量图层Vector作为绘制层
        var source = new ol.source.Vector({
            features: [polygon]
        });
        //创建一个图层
        vectorDrawing = new ol.layer.Vector({
            source: source
        });
        //将绘制层添加到地图容器中
        map.addLayer(vectorDrawing);
    }

    var map,vectorDrawing;
    function onLoad() {
        load();
    }
    function zOnClick(event) {
       var data={"server_name":event};
       // var Export={"server_name":"Export_Output"};
        var count = map.getLayers().getLength();
        if (count != 2) {
            for (var i = count - 1; i > 1; i--) {
                map.removeLayer(map.getLayers().item(i));
            }
        }
        if(mapClick!=null && mapClick.length>0){
            for(var i=0;i<mapClick.length;i++){
                ol.Observable.unByKey(mapClick[i]);
            }
        }
            shpInfo(data);
            // shpInfo(Export);
    }

    //创建对象
    // geocoder = new T.Geocoder();
    // function searchResult(result)
    // {
    //     if(result.getStatus() == 0){
    //         alert(result.getLocationPoint().lng+"---"+result.getLocationPoint().lat)
    //         // map.panTo(result.getLocationPoint(), 16);
    //
    //         //获取地图视图
    //         var view = map.getView();
    //         var py = ol.proj.fromLonLat([result.getLocationPoint().lng, result.getLocationPoint().lat]);
    //         //平移地图
    //         view.setCenter(py);
    //
    //     }else{
    //         alert(result.getMsg());
    //     }
    //
    // }
    //
    // function searchtest(){
    //     geocoder.getPoint("包头市青山区", searchResult);
    // }

</script>

</body>
<!-- 导入区域 -->
<script id="importTpl" type="text/template">
    <form enctype="multipart/form-data" class="mt20 mb10">
        <div class="col-xs-offset-1">
            <input type="file" id="file" name="files" multiple="multiple"/>
            <div class="mt10 pt5">
                <input type="checkbox" id="updateSupport" name="updateSupport" title="如果登录账户已经存在，更新这条数据。"> 是否更新已经存在的用户数据
                <!--&nbsp;	<a onclick="$.table.importTemplate()" class="btn btn-default btn-xs"><i class="fa fa-file-excel-o"></i> 下载模板</a>-->
            </div>
            <font color="red" class="pull-left mt10">
                提示：仅允许导入“xls”或“xlsx”格式文件！
            </font>
        </div>
    </form>
</script>
</html>