var map, spotinfos,vectorDrawing;
var prefixGis = ctx + "system/gis";
var prefixGisFeatures = ctx + "system/gisFeatures";
var prefixGisTab = ctx + "system/gisTab";
var prefixGisMap = ctx + "system/gisMap";
var prefixPostGis = ctx + "system/postGis";
function onLoad() {
    load();
    if(document.getElementById("layerTree")!=null && document.getElementById("layerTree")!=''){
        loadLayersControl(map, "layerTree");
    }
}
function gisClean(id,map) {
    if(pointQueryTitleSource!=null && pointQueryTitleSource!=""){
        map.removeLayer(pointQueryTitleSource);
    }
    if (id!=''){
        clearGis(map);
    }else{
        if(titleNames.length>0){
            for(var i=0;i<titleNames.length;i++){
                map.removeLayer(titleNames[i]);
            }
        }
    }
    titleNames=[];
}
//加载专题数据 点击专题
function queryDeptTree(map,id) {
    var url = prefixGisFeatures + "/getList";
    var options = {
        id:"thematicLayer"+id,
        url: url,
        expandLevel: 1,
        check: {enable: true},
        onCheck: zOnClick
    };
    $.tree.init(options);

    function zOnClick(event, tree) {
        gisClean(id,map);
        var idsThematicLayer = $.tree.getGisCheckedNodes("thematicLayer"+id);
        var idsBusinessLayer = $.tree.getGisCheckedNodes("businessLayer"+id);
        if (idsBusinessLayer != undefined && idsBusinessLayer != null && idsBusinessLayer != '') {
            var generic_code="generic_code in (" + idsBusinessLayer + ")";
            var bundle_code="or bundle_code in (" + idsBusinessLayer + ")";
            shpInfo(generic_code+bundle_code,map);
        }
        if (idsThematicLayer != undefined && idsThematicLayer != null && idsThematicLayer != '') {
            $.post(prefixGis + "/getSpot",
                {shpIds: idsThematicLayer}, function (res) {
                    for (var i = 0; i < res.data.length; i++) {
                        var type="project_type='" + res.data[i].id + "'";
                        loadgis(type,gisMapName,map);
                    }
                })
        }
    }
}

//加载业务图层 点击事件
function serviceTree(map,id) {
    var url = prefixPostGis + "/getGressTypeList";
    var options = {
        id:"businessLayer"+id,
        url: url,
        expandLevel: 1,
        check: {enable: true},
        onCheck: zOnClick
    };
    $.tree.init(options);
    function zOnClick(event, tree) {
        gisClean(id,map);
        var idsThematicLayer = $.tree.getGisCheckedNodes("thematicLayer"+id);
        var idsBusinessLayer = $.tree.getGisCheckedNodes("businessLayer"+id);
        if (idsThematicLayer != undefined && idsThematicLayer != null && idsThematicLayer != '') {
            $.post(prefixGis + "/getSpot",
                {shpIds: idsThematicLayer}, function (res) {
                    for (var i = 0; i < res.data.length; i++) {
                        var type="project_type='" + res.data[i].id + "'";
                        loadgis(type,gisMapName,map);
                    }
                })
        }
        if (idsBusinessLayer != undefined && idsBusinessLayer != null && idsBusinessLayer != '') {
            var generic_code="generic_code in (" + idsBusinessLayer + ")";
            var bundle_code="or bundle_code in (" + idsBusinessLayer + ")";
            shpInfo(generic_code+bundle_code,map);            }
    }
}

$('#btnExpand').click(function () {
    $._tree.expandAll(true);
    $(this).hide();
    $('#btnCollapse').show();
});
/*$('#btnRefresh').click(function () {
    queryDeptTree();
});*/

$('#btnCollapse').click(function () {
    $._tree.expandAll(false);
    $(this).hide();
    $('#btnExpand').show();
});

function updateCity() {
    $.get(prefixGis + "/getDistrictSheng",
        function (res) {
            if (vectorDrawing != null) {
                map.removeLayer(vectorDrawing);
            }
            var cityHtml = "";
            for (var i = 0; i < res.length; i++) {
                let cityName="";
                if(res[i].cityName.length>5){
                    cityName=res[i].cityName.substring(0,5)+"..";
                }else{
                    cityName=res[i].cityName.substring(0,res[i].cityName.length);
                }
                cityHtml += "<li onclick='getSheng(" + res[i].id + ")'>" + cityName + "</li>";
            }
            $(".zq_ul").text("");
            $(".zq_ul").append(cityHtml);
            $("#type3").val('全国');
            $(".content_ul").html('全国');
            $("#dist_positioning").show();
        })
}

function getSheng(id) {
    var view = map.getView();
    $.get(prefixGis + "/getDistrictShi/" + id, function (res) {
        var cityHtml = "";
        for (var i = 0; i < res.citys.length; i++) {
            let cityName="";
            if(res.citys[i].cityName.length>5){
                cityName=res.citys[i].cityName.substring(0,5)+"..";
            }else{
                cityName=res.citys[i].cityName.substring(0,res.citys[i].cityName.length);
            }
            cityHtml += "<li onclick='getShi(" + res.citys[i].id + ")'>" + cityName + "</li>";
        }
        var cityHtm = "<span style='cursor: pointer' onclick='updateCity()'>全国</span> <span style='cursor: pointer;color: #43bfac;' onclick='getSheng(" + res.city.id + ")'> > " + res.city.cityName + "</span>";
        $(".content_ul").html(cityHtm);
        $(".zq_ul").text("");
        $(".zq_ul").append(cityHtml);
        $("#dist_positioning").show();
        var can = res.city.canter.split(",");
        view.setCenter([parseFloat(can[0]), parseFloat(can[1])]);
        view.setZoom(7)
        $("#type3").val(res.city.cityName);
        plotCity(res.city.cityName, "province_name like'" + res.city.cityName + "%'", res.city.id, "division");
    })
}

function getShi(id) {
    var view = map.getView();
    $.get(prefixGis + "/getDistrictQu/" + id, function (res) {
        $(".zq_ul").text("");
        var cityHtml = "";
        if (res.citys != null) {
            for (var i = 0; i < res.citys.length; i++) {
                let cityName="";
                if(res.citys[i].cityName.length>5){
                    cityName=res.citys[i].cityName.substring(0,5)+"..";
                }else{
                    cityName=res.citys[i].cityName.substring(0,res.citys[i].cityName.length);
                }
                cityHtml += "<li onclick='getQu(" + res.citys[i].id + ")'>" + cityName + "</li>";
            }
            $(".zq_ul").append(cityHtml);
        }
        var cityHtm = "<span style='cursor: pointer' onclick='getShi('" + res.city.id + "')'> > " + res.city.cityName + "</span>";
        $(".content_ul").append(cityHtm);
        $("#dist_positioning").show();
        var can = res.city.canter.split(",");
        view.setCenter([parseFloat(can[0]), parseFloat(can[1])]);
        view.setZoom(7)
        $("#type3").val(res.city.cityName);
        plotCity(res.city.cityName, "city_name ='" + res.city.cityName + "'", res.city.id, "division");
    })
}

function getQu(id) {
    var view = map.getView();
    $.get(prefixGis + "/getDistrictById/" + id, function (res) {
        var cityHtml = "";
        $(".zq_ul").text("");
        if (res.citys != null) {
            var cityHtml = "";
            for (var i = 0; i < res.citys.length; i++) {
                cityHtml += "<li>" + res.citys[i].cityName + "</li>";
            }
            $(".zq_ul").append(cityHtml);
        }
        $("#dist_positioning").show();

        var can = res.city.canter.split(",");
        view.setCenter([parseFloat(can[0]), parseFloat(can[1])]);
        view.setZoom(7)
        $("#type3").val(res.city.cityName);
        plotCity(res.city.cityName, "name='" + res.city.cityName + "'", res.city.id, "qu");
    })
}

function cityDivDoneById(name) {
    var newNam = "#" + name;
    $(newNam).hide();
    $("#type3").val('全国');
    if (vectorDrawing != null) {
        map.removeLayer(vectorDrawing);
    }

}
$(function () {
    var panehHidden = false;
    if ($(this).width() < 769) {
        panehHidden = true;
    }
    $('body').layout({initClosed: panehHidden, west__size: 185});
});

/*展示树状列表*/
$('.layer_tree_show_map').on('click',function () {
    $('.west').show();
    $('.layer_tree_hide').show();
    queryDeptTree(map,"");
    serviceTree(map,"");
});

$('.layer_tree_hide i').on('click',function () {
    $('.west').hide();
    $('.layer_tree_hide').hide();
});

/* 上报信息列表-条件查询弹框 */
$("#conditionQuery").click(function(){
    let conditionQuery_sel = $('.conditionQuery_sel');
    if(conditionQuery_sel[0].style.display=="none"){
        $('.conditionQuery_sel').show();
    }else{
        $('.conditionQuery_sel').hide();
    }
});

/* 标记列表 */
$("#markedList").click(function(){
    let options = {
        id:"tagTable",
        url: prefixGisTab+"/getList",
        modalName: "新增退牧还草工程进度",
        striped: false,
        bordered: false,
        pagination:true,
        showSearch: false,
        showToggle: false,
        showColumns: false,
        showRefresh: false,
        columns: [
            [
                {
                    field: 'index',
                    title: '序号',
                    rowspan: 1,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle',
                    formatter: function (value, row, index) {
                        return index + 1;
                    }
                },
                {
                    field: 'address',
                    title: '地区',
                    rowspan: 1,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle',
                    formatter: function (value, row, index) {
                        let ht = "<div onclick=onClickRowMark('"+row.id + "','" + row.centre + "')></div>";
                        return row.address + ht;
                    }
                },
                {
                    field: 'name',
                    title: '标签标题',
                    rowspan: 1,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle',
                },
                {
                    field: 'createTime',
                    title: '创建时间',
                    rowspan: 1,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle',
                },
                {
                    title: '标签类型',
                    rowspan: 1,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle',
                    formatter: function (value, row, index) {
                        return row.type == 1 ? '点':'面';
                    }
                },
                {
                    title: '面积',
                    rowspan: 1,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle',
                    border: 1,
                    formatter: function (value, row, index) {
                        return row.area + '万km²';
                    }
                },
                {
                    field: 'remark',
                    title: '备注',
                    rowspan: 1,
                    colspan: 1,
                    align: 'center',
                    valign: 'middle'
                },
            ],
        ]
    };
    $.table.init(options);
    $('.reportList').show();
    $('#reportDiv').hide();//专题
    $('#businessDiv').hide();//业务
    $('#tagDiv').show();//标记
});

/* 业务查询 */
$("#business").click(function(){
    businessSearch();
    let cityHtml = '<option value="">--请选择--</option>';
    $.get(prefixPostGis + "/getSection",
        function (res) {
            for (var i = 0; i < res.length; i++) {
                cityHtml += '<option value="'+ res[i].section +'">'+ res[i].section +'</option>';
            }
            $("#section").text("");
            $("#section").append(cityHtml);
        })
});
function sectionOncheng() {
    let cityHtml = '<option value="">--请选择--</option>';
    $("#bundle").text("");
    $("#bundle").append(cityHtml);
    $("#generic").text("");
    $("#generic").append(cityHtml);
    var section= $("#section").val()
    if(section!=null && section!=''){
        $.get(prefixPostGis + "/getGeneric?section="+section,
            function (res) {
                for (var i = 0; i < res.length; i++) {
                    cityHtml += '<option value="'+ res[i].generic +'">'+ res[i].generic +'</option>';
                }
                $("#generic").text("");
                $("#generic").append(cityHtml);
            })
    }

}
function bundleOncheng() {
    let cityHtml = '<option value="">--请选择--</option>';
    $("#bundle").text("");
    $("#bundle").append(cityHtml);
    var generic= $("#generic").val()
    if(generic!=null && generic!=""){
        $.get(prefixPostGis + "/getBundle?generic="+generic,
            function (res) {
                for (var i = 0; i < res.length; i++) {
                    cityHtml += '<option value="'+ res[i].bundle +'">'+ res[i].bundle +'</option>';
                }
                $("#bundle").text("");
                $("#bundle").append(cityHtml);
            })
    }
}
/* 业务查询搜索 */
function businessSearch(){
    $.table.destroy('businessTable');
    var options = {
        id:"businessTable",
        pagination:true,
        url:prefixPostGis + "/getGressList",
        showSearch: false,
        showToggle: false,
        showColumns: false,
        showRefresh: false,
        pageList:[5,10,15],//分页步进值
        pageSize: 5,
        columns: [
            {
                field: 'province_name',
                title: '地区',
                align: 'center',
                valign: 'middle',
                class:true,
                formatter: function (value, row, index){
                    var centroid=  row.centroid.replace("POINT(","").replace(")","").replace(" ",",");
                    let ht ="<div onclick=grassPositioning('"+row.id + "','" + centroid + "')></div>";
                    return row.province_name + ht;
                }
            },
            {
                field: 'item',
                title: '属',
                align: 'center',
                valign: 'middle',
            },
            {
                field: 'section',
                title: '目',
                align: 'center',
                valign: 'middle',
            },
            {
                field: 'generic',
                title: '科',
                align: 'center',
                valign: 'middle',
            },
            {
                field: 'bundle',
                title: '丛',
                align: 'center',
                valign: 'middle',
            },
            {
                field: 'area',
                title: '占地面积(km²)',
                align: 'center',
                valign: 'middle',
                formatter: function (value, row, index){
                    var num =row.area /1000000;
                    return num.toFixed(2);
                }
            },

        ]
    }
    $.table.init(options);
    $('.reportList').show();
    $('#reportDiv').hide();//专题
    $('#businessDiv').show();//业务
    $('#tagDiv').hide();//标记
}




/* 专题查询 */
$("#special").click(function(){
    var prefix = ctx + "caiji/survey";

    var options = {
        id:"reportTable",
        url: prefix + "/list",
        createUrl: prefix + "/add",
        updateUrl: prefix + "/edit/{id}",
        removeUrl: prefix + "/remove",
        detailUrl: prefix + "/check/{id}",
        exportUrl: prefix + "/export",
        showSearch:false,
        showRefresh:false,
        showColumns:false,
        showToggle:false,
        onClickRow: onClickRow,
        //pageList:[3,6,9,12],//分页步进值
        pageSize: 5,
        modalName: "地面调查数据",
        columns: [
            {
                field : 'codeId',
                align: 'center',
                valign: 'middle',
                title : '样地编号'
            },
            {
                field : 'provincialLevelName',
                align: 'center',
                valign: 'middle',
                title : '省级名称'
            },
            {
                field : 'cityLevelName',
                align: 'center',
                valign: 'middle',
                title : '地级名称'
            },
            {
                field : 'countyLevelName',
                align: 'center',
                valign: 'middle',
                title : '县级名称'
            },
            /*  {
                  field : 'surveyTime',
                  align: 'center',
                  valign: 'middle',
                  title : '调查时间'
              },*/
            {
                field : 'createTime',
                align: 'center',
                valign: 'middle',
                title : '创建时间'
            },
            {
                field : 'staute',
                align: 'center',
                valign: 'middle',
                title : '状态',
            },
        ]
    };

    $.table.init(options);
    $('.reportList').show();
    $('#reportDiv').show();//专题
    $('#businessDiv').hide();//业务
    $('#tagDiv').hide();//标记
});

/*专题列表点击图标定位*/
function specialPositioning(mapId) {
    if(mapId!=null && mapId!='null'){
        $.get(prefixGisMap+"/getTabById?id="+mapId,function (res) {
            if(res!=null && res!=""){
                loadgisByMapId(res.id,res.centre);
            }else{
                layer.msg("当前数据未绑定图层",{icon: 6, time: 3000});
            }
        })
    }else{
        layer.msg("当前数据未绑定图层",{icon: 6, time: 3000});
    }
}

/* 关闭上报信息列表 */
function closeReportList() {
    $('.reportList').hide();
}

/* 标记列表 单击行定位上报图层 */
function onClickRowMark(id,centre){
    loadgisByTabId(id,centre);
}

function onClickRow(row, $element) {

    if (row.mapId != null) {
        $.get(prefixGisMap + "/getTabById?id=" + row.mapId, function (res) {
            if(res!=null && res!=""){
                loadgisByMapId(res.id,res.centre);
            }else{
                layer.msg("当前数据未绑定图层.",{icon: 6, time: 3000});
            }
        })
    }

}


function grassPositioning(id,centroid){
    var idType="id =" + id + "";
    grassPosit(idType,centroid);
}

layui.use('laydate', function () {
    var laydate = layui.laydate;
    //执行一个laydate实例
    laydate.render({
        elem: '#test2'
        , type: 'year'
    });
});

/* 省市区三级联动 */
// ===== 切换省份 =====
$("#province").change(function () {
    let provinceCode = $('#province option:selected').val();
    $("#city").empty();
    $("#area").empty();
    //获取所属市级
    getCitiess(provinceCode);
});
// ===== 切换市级 =====
$("#city").change(function () {
    let cityCode = $('#city option:selected').val();
    $("#area").empty();
    //获取区县级
    getAreass(cityCode);
});

// ===== 加载市列表 =====
function getCitiess(provinceCode) {
    var url = ctx + "system/analysis/getCities";
    $.ajax({
        "url": url,
        "data": {"provinceCode": provinceCode},
        "type": "post",
        "dataType": "json",
        "success": function (data) {
            var op = document.createElement("option");
            op.value = '';
            op.text = "-- 请选择地址 --";
            document.getElementById("city").appendChild(op);
            let cityHtml = '';
            for (var i = 0; i < data.length; i++) {
                var op = document.createElement("option");
                op.value = data[i].dictCode;
                op.text = data[i].dictLabel;
                document.getElementById("city").appendChild(op);
                cityHtml += '<li dictCode="' + data[i].dictCode + '">' + data[i].dictLabel + '</li>';
            }
            $('#sel_city').html(cityHtml);
        }
    });
    var op2 = document.createElement("option");
    op2.value = '';
    op2.text = "-- 请选择地址 --";
    document.getElementById("area").appendChild(op2);
    $('#sel_area').html('');
}

// ===== 加载区列表 =====
function getAreass(cityCode) {
    var url = prefixPostGis + "/getGressTypeList";
    $.ajax({
        "url": url,
        "data": {"cityCode": cityCode},
        "type": "post",
        "dataType": "json",
        "success": function (data) {
            var op = document.createElement("option");
            op.value = '';
            op.text = "-- 请选择地址 --";
            document.getElementById("area").appendChild(op);
            let areaHtml = '';
            for (var i = 0; i < data.length; i++) {
                var op = document.createElement("option");
                op.value = data[i].dictCode;
                op.text = data[i].dictLabel;
                document.getElementById("area").appendChild(op);
                areaHtml += '<li dictCode="' + data[i].dictCode + '">' + data[i].dictLabel + '</li>';
            }
            $('#sel_area').html(areaHtml);
        }
    });
}

/* 省市区三级联动end */

/* 经纬度定位 */
$('#locationShow').on("click",function () {
    $('.coordinatePositioning').show();
})

/* 经纬度定位 */
$("#positioning_btn").on("click",function () {
    let decimalLon = $('#decimalLon').val();//经度
    let decimalLat = $('#decimalLat').val();//纬度
    locationCenter(decimalLon,decimalLat);
})
/* 关闭 */
$("#closePositioning").on("click",function () {
    $(".coordinatePositioning").hide();
})