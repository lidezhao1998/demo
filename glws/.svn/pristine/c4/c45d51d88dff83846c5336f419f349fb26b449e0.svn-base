<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>加载天地图</title>
    <th:block th:include="include :: header('地图')"/>
</head>
<body onLoad="onLoad()">
<div class="ui-layout-center">
    <div class="col-sm-12 search-collapse" id="savaInput">
        <input type="hidden" name="spotinfos" id="spotinfos" value=""><!--保存坐标信息-->
    </div>
    <div class="container-div">
        <div class="row">
            <div id="map">

            </div>
        </div>
    </div>

</div>

</div>
</body>
<script type="text/javascript">
    var map, spotinfos,vectorDrawing,type="service";
</script>
<th:block th:include="include :: footer"/>
<th:block th:include="include :: layout-latest-css"/>
<th:block th:include="include :: ztree-css"/>
<th:block th:include="include :: layout-latest-js"/>
<th:block th:include="include :: ztree-js"/>
<script type="text/javascript">
    var prefix = ctx + "system/gis";
    var prefixGisFeatures = ctx + "system/gisFeatures";
    var prefixGisTab = ctx + "system/gisTab";
    var reportPrefix = ctx + "system/report";
    var analysisPrefix = ctx + "system/analysis";
    function onLoad() {
        load();
    }

    //加载专题数据 点击专题
    function queryDeptTree() {
        type="dept";
        var url = prefixGisFeatures + "/getList/1";
        var options = {
            url: url,
            expandLevel: 2,
            check: {enable: true},
            onCheck: zOnClick
        };
        $.tree.init(options);

        function zOnClick(event, tree) {
            var count = map.getLayers().getLength();
            if (count != 2) {
                for (var i = count - 1; i > 1; i--) {
                    map.removeLayer(map.getLayers().item(i));
                }
            }
            var ids = $.tree.getCheckedNodes();
            if (ids != undefined && ids != null && ids != '') {
                $.post(prefix + "/getSpot",
                    {shpIds: ids}, function (res) {
                        for (var i = 0; i < res.data.length; i++) {
                            var type="project_type='" + res.data[i].id + "'";
                            loadgis(type,gisMapName);
                        }
                    })
            }else{
                ol.Observable.unByKey(mapClick);
            }
        }

    }

    //加载业务图层 点击事件
    function serviceTree() {
        type="service";
        var url = prefixGisFeatures + "/getList/2";
        var options = {
            url: url,
            expandLevel: 2,
            check: {enable: true},
            onCheck: zOnClick
        };
        $.tree.init(options);

        function zOnClick(event, tree) {
            var count = map.getLayers().getLength();
            if (count != 2) {
                for (var i = count - 1; i > 1; i--) {
                    map.removeLayer(map.getLayers().item(i));
                }
            }
            var ids = $.tree.getCheckedNodes();
            if (ids != undefined && ids != null && ids != '') {
                $.post(prefix + "/getSpot",
                    {shpIds: ids}, function (res) {
                        for (var i = 0; i < res.data.length; i++) {
                            shpInfo(res.data[i]);
                        }
                    })
            }
            else{
                ol.Observable.unByKey(mapClick);
            }
        }
    }

    $('#btnExpand').click(function () {
        $._tree.expandAll(true);
        $(this).hide();
        $('#btnCollapse').show();
    });
    $('#btnRefresh').click(function () {
        queryDeptTree();
    });

    $('#btnCollapse').click(function () {
        $._tree.expandAll(false);
        $(this).hide();
        $('#btnExpand').show();
    });

    function updateCity() {
        $.get(prefix + "/getDistrictSheng",
            function (res) {
                if (vectorDrawing != null) {
                    map.removeLayer(vectorDrawing);
                }
                var cityHtml = "";
                for (var i = 0; i < res.length; i++) {
                    cityHtml += "<li onclick='getSheng(" + res[i].id + ")'>" + res[i].cityName + "</li>";
                }
                $(".zq_ul").text("");
                $(".zq_ul").append(cityHtml);
                $("#type3").val('全国');
                $(".content_ul").html('全国');
                $("#dist_positioning").show();
            })
    }

    function getSheng(id) {
        var view = map.getView();
        $.get(prefix + "/getDistrictShi/" + id, function (res) {
            var cityHtml = "";
            for (var i = 0; i < res.citys.length; i++) {
                cityHtml += "<li onclick='getShi(" + res.citys[i].id + ")'>" + res.citys[i].cityName + "</li>";
            }
            var cityHtm = "<span style='cursor: pointer' onclick='updateCity()'>全国</span> <span style='cursor: pointer;color: #43bfac;' onclick='getSheng(" + res.city.id + ")'> > " + res.city.cityName + "</span>";
            $(".content_ul").html(cityHtm);
            $(".zq_ul").text("");
            $(".zq_ul").append(cityHtml);
            $("#dist_positioning").show();
            var can = res.city.canter.split(",");
            view.setCenter([parseFloat(can[0]), parseFloat(can[1])]);
            view.setZoom(7)
            $("#type3").val(res.city.cityName);
            plotCity(res.city.cityName, "name='" + res.city.cityName + "'", res.city.id, "division");
        })
    }

    function getShi(id) {
        var view = map.getView();
        $.get(prefix + "/getDistrictQu/" + id, function (res) {
            $(".zq_ul").text("");
            var cityHtml = "";
            if (res.citys != null) {
                for (var i = 0; i < res.citys.length; i++) {
                    cityHtml += "<li onclick='getQu(" + res.citys[i].id + ")'>" + res.citys[i].cityName + "</li>";
                }
                $(".zq_ul").append(cityHtml);
            }
            var cityHtm = "<span style='cursor: pointer' onclick='getShi('" + res.city.id + "')'> > " + res.city.cityName + "</span>";
            $(".content_ul").append(cityHtm);
            $("#dist_positioning").show();
            var can = res.city.canter.split(",");
            view.setCenter([parseFloat(can[0]), parseFloat(can[1])]);
            view.setZoom(7)
            $("#type3").val(res.city.cityName);
            plotCity(res.city.cityName, "CityNameC ='" + res.city.cityName + "'", res.city.id, "shi");
        })
    }

    function getQu(id) {
        var view = map.getView();
        $.get(prefix + "/getDistrictById/" + id, function (res) {
            var cityHtml = "";
            $(".zq_ul").text("");
            if (res.citys != null) {
                var cityHtml = "";
                for (var i = 0; i < res.citys.length; i++) {
                    cityHtml += "<li>" + res.citys[i].cityName + "</li>";
                }
                $(".zq_ul").append(cityHtml);
            }
            $("#dist_positioning").show();

            var can = res.city.canter.split(",");
            view.setCenter([parseFloat(can[0]), parseFloat(can[1])]);
            view.setZoom(7)
            $("#type3").val(res.city.cityName);
            plotCity(res.city.cityName, "name='" + res.city.cityName + "'", res.city.id, "qu");
        })
    }

    function cityDivDoneById(name) {
        var newNam = "#" + name;
        $(newNam).hide();
        $("#type3").val('全国');
        if (vectorDrawing != null) {
            map.removeLayer(vectorDrawing);
        }

    }

    $(function () {
        var panehHidden = false;
        if ($(this).width() < 769) {
            panehHidden = true;
        }
        $('body').layout({initClosed: panehHidden, west__size: 185});
        serviceTree();
    });

    $('.layer_tree_show_map').on('click',function () {
        $('.west').show();
        $('.layer_tree_hide').show();
    });

    $('.layer_tree_hide i').on('click',function () {
        $('.west').hide();
        $('.layer_tree_hide').hide();
    });


    /* 关闭上报信息列表 */
    function closeReportList() {
        $('.reportList').hide();
    }

    /* 单击行定位上报图层 */
    function onClickRow(row, $element){
        //  alert("单击行mapId：" + row.mapId);
        loadgisByMapId(row.mapId,null);
    }

    /* 标记列表 单击行定位上报图层 */
    function onClickRowMark(row, $element){
        loadgisByTabId(row.id,row.centre);
    }

    //标记图层加载
    function loadgisByTabId(tid, centre) {
        var vector = new ol.layer.Tile({
            source: new ol.source.TileWMS({
                url: gisUrl + urlLayer,
                params: {
                    FORMAT: 'image/png',
                    VERSION: '1.1.1',
                    tiled: true,
                    exceptions: 'application/vnd.ogc.se_inimage',
                    LAYERS: gisTabName,
                    FeatureID: tid
                }
            })
        });
        if (centre != null) {
            var cent = centre.split(",");
            var view = map.getView();
            view.setZoom(10);
            view.setCenter([parseFloat(cent[0]), parseFloat(cent[1])]);
        }
        map.addLayer(vector);
    }

    function onClickCell(field, value, row, $element){
        //alert("单击格name：" + field + " value：" + value);
    }

    layui.use('laydate', function () {
        var laydate = layui.laydate;
        //执行一个laydate实例
        laydate.render({
            elem: '#test2'
            , type: 'year'
        });
    });

    /* 省市区三级联动 */
    // ===== 切换省份 =====
    $("#province").change(function () {
        let provinceCode = $('#province option:selected').val();
        $("#city").empty();
        $("#area").empty();
        //获取所属市级
        getCitiess(provinceCode);
    });
    // ===== 切换市级 =====
    $("#city").change(function () {
        let cityCode = $('#city option:selected').val();
        $("#area").empty();
        //获取区县级
        getAreass(cityCode);
    });

    // ===== 加载市列表 =====
    function getCitiess(provinceCode) {
        var url = ctx + "system/analysis/getCities";
        $.ajax({
            "url": url,
            "data": {"provinceCode": provinceCode},
            "type": "post",
            "dataType": "json",
            "success": function (data) {
                var op = document.createElement("option");
                op.value = '';
                op.text = "-- 请选择地址 --";
                document.getElementById("city").appendChild(op);
                let cityHtml = '';
                for (var i = 0; i < data.length; i++) {
                    var op = document.createElement("option");
                    op.value = data[i].dictCode;
                    op.text = data[i].dictLabel;
                    document.getElementById("city").appendChild(op);
                    cityHtml += '<li dictCode="' + data[i].dictCode + '">' + data[i].dictLabel + '</li>';
                }
                $('#sel_city').html(cityHtml);
            }
        });
        var op2 = document.createElement("option");
        op2.value = '';
        op2.text = "-- 请选择地址 --";
        document.getElementById("area").appendChild(op2);
        $('#sel_area').html('');
    }

    // ===== 加载区列表 =====
    function getAreass(cityCode) {

        var url = ctx + "system/analysis/getAreas";
        $.ajax({
            "url": url,
            "data": {"cityCode": cityCode},
            "type": "post",
            "dataType": "json",
            "success": function (data) {
                var op = document.createElement("option");
                op.value = '';
                op.text = "-- 请选择地址 --";
                document.getElementById("area").appendChild(op);
                let areaHtml = '';
                for (var i = 0; i < data.length; i++) {
                    var op = document.createElement("option");
                    op.value = data[i].dictCode;
                    op.text = data[i].dictLabel;
                    document.getElementById("area").appendChild(op);
                    areaHtml += '<li dictCode="' + data[i].dictCode + '">' + data[i].dictLabel + '</li>';
                }
                $('#sel_area').html(areaHtml);
            }
        });
    }

    /* 省市区三级联动end */
</script>
<style type="text/css">
    body, html {
        width: 100%;
        height: 100%;
        margin: 0;
        font-family: "微软雅黑";
    }
    #map {
        height: 100%;
        width: 100%;
    }
    #savaInput {
        float: right;
        margin-top: 0px;
        padding-top: 0px;
        padding-bottom: 0px;
    }
    #menu {
        float: right;
        position: absolute;
        right: 50%;
        z-index: 2000;
    }
    #zqdw {
        float: left;
        width: 100%;
    }
    #dist_positioning {
        position: absolute;
        z-index: 10;
        top: 6%;
        width: 380px;
        min-height: 50px;
        background: #fff;
        box-shadow: 0 1px 10px 1px #ccc;
        display: none;
        left: 30px;
    }
    #shpTitle{
        height: 250px;
        bottom: 3px;
        position: absolute;
        z-index: 2001;
        display: none;
    }
    #dist_positioning ul{
        padding: 0px;
    }
    #dist_positioning ul li {
        float: left;
        width: 90px;
        min-width: 90px;
        text-align: center;
        line-height: 25px;
        padding: 0 8px;
        margin: 2px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid #efefef;
        word-break: keep-all;
        list-style: none;
    }
    #dist_positioning ul li:hover {
        background-color:  rgba(48,146,62, 0.9);
        color:  white;
    }
    #menu3 {
        float: left;
        position: absolute;
        bottom: 95%;
        left: 30px;
        z-index: 2000;
    }
    input, b {
        margin-left: 5px;
        font-size: 14px
    }
    input {
        margin-top: 10px;
        margin-left: 5px;
        font-size: 14px;
        text-align: center;
    }
    /* 鼠标位置控件层样式设置 */
    #mouse-position {
        float: right;
        position: absolute;
        left: 40%;
        bottom: 5px;
        width: 200px;
        height: 20px;
        /*在地图容器中的层，要设置z-index的值让其显示在地图上层*/
        z-index: 2000;
    }
    #dist_positioning p {
        width: 100%;
        height: 35px;
        line-height: 35px;
        padding-left: 20px;
        font-size: 14px;
        background: #f7f7f7;
    }
    #zqdw .content_ul {
        width: auto;
        min-width: 50px;
        height: 30px;
        line-height: 30px;
        font-size: 12px;
    }
    /* 鼠标位置信息自定义样式设置 */
    .custom-mouse-position {
        color: rgb(0,0,0);
        font-size: 18px;
        font-family: "微软雅黑";
    }
    /**
   * 提示框的样式信息
   */
    .tooltip {
        position: relative;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
        color: white;
        padding: 4px 8px;
        opacity: 0.7;
        white-space: nowrap;
    }

    .tooltip-measure {
        opacity: 1;
        font-weight: bold;
    }

    .tooltip-static {
        background-color: #ffcc33;
        color: black;
        border: 1px solid white;
    }

    .tooltip-measure:before,
    .tooltip-static:before {
        border-top: 6px solid rgba(0, 0, 0, 0.5);
        border-right: 6px solid transparent;
        border-left: 6px solid transparent;
        content: "";
        position: absolute;
        bottom: -6px;
        margin-left: -7px;
        left: 50%;
    }

    .west{
        position: absolute;
        margin: 0px;
        left: 36px;
        right: auto;
        top: 50px;
        bottom: 0px;
        height: 568px;
        z-index: 1;
        overflow: hidden;
        width: 185px;
        display: none;
        visibility: visible;
    }
    .layer_tree_show{
        position: absolute;
        width: 50px;
        height: 50px;
        left: 36px;
        right: auto;
        top: 50px;
        bottom: 0px;
        z-index: 1;
        font-size: 25px;
        color:  rgba(48,146,62, 0.9);
        cursor: pointer;
    }
    .layer_tree_hide{
        position: absolute;
        width: 20px;
        height: 45px;
        left: 221px;
        right: auto;
        top: 50px;
        bottom: 0px;
        z-index: 1;
        font-size: 14px;
        color:  rgba(48,146,62, 0.9);
        background-color: #ececec;
        padding-top: 10px;
        cursor: pointer;
        display: none;
    }
    .layer_tree_hide i{
        padding: 4px;
    }
    .header-r {
        position: absolute;
        z-index: 2;
        height: 40px;
        padding-left: 10px;
        background: #fff;
        background-size: 100%;
        padding-right: 10px;
        right: 20px;
        top: 6px;
        border-radius: 3px;
    }
    .header-r .header-r-bg {
        margin-top: 5px;
        display: inline-block;
        padding: 0 5px;
        background: #fff;
        border-radius: 20px;
    }
    .header-r a {
        position: relative;
        display: inline-block;
        height: 30px;
        line-height: 30px;
        color: #000;
        font-size: 14px;
        padding: 0 10px 0 20px;
    }
    .header-r a:hover {
        text-decoration: none !important;
        color: #ff6600;
    }
    .layer_tree_show_map{
        position: absolute;
        width: 32px;
        height: 32px;
        z-index: 2;
        background: url(../../img/icon-map-dq.png) no-repeat center;
    }
    #off{
        border: 0px;
        cursor: pointer;
        color: rgba(48,146,62, 0.9);
        font-size: 16px;
        display: none;
        background-color: white;
        width: 100px;
        height: 36px;
        border-radius: 16px;
        outline: none;
    }
    /* 上报任务列表 */
    .reportList{
        color: rgba(48,146,62, 0.9);
        position: absolute;
        margin: 0px;
        top: auto;
        bottom: 0px;
        left: 0px;
        right: 0px;
        width: auto;
        z-index: 0;
        display: none;
        visibility: visible;
    }

    /*修改表头颜色*/
    .table-bordered table thead{
        background-color:rgba(48,146,62, 0.9);
        color: whitesmoke;
        height: 30px;
    }
    /*按钮背景色*/
    .btn-success{
        background-color: #30923E;
    }

</style>
</html>
