<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sinosoft.extinterface.mapper.SpatialPlanningMapper">

    <resultMap type="com.sinosoft.extinterface.domain.SpatialPlanning" id="SpatialPlanning">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="status" column="status"/>
        <result property="parentId" column="parent_id"/>
        <result property="ancestors" column="ancestors"/>
        <result property="shpFilePath" column="shpFile_path"/>
        <result property="shpColor" column="shp_color"/>
        <result property="orderNum" column="order_num"/>
        <result property="item" column="item"/>
        <result property="itemCode" column="item_code"/>
        <result property="generic" column="generic"/>
        <result property="genericCode" column="generic_code"/>
        <result property="sectionCode" column="section_code"/>
        <result property="section" column="section"/>
        <result property="status" column="status"/>
        <result property="bundle" column="bundle"/>
        <result property="bundleCode" column="bundle_code"/>
        <result property="provinceName" column="province_name"/>
        <result property="geomData" column="geom_data"/>
        <result property="fileName" column="fileName"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="province" column="province"/>
        <result property="city" column="city"/>
        <result property="county" column="county"/>
        <result property="grassType" column="grass_type"/>
    </resultMap>
    <sql id="selectShpFileVo">
        select d.id,
               d.parent_id,
               d.ancestors,
               d.name,
               d.shpFile_path,
               d.shp_color,
               d.order_num,
               d.status,
               d.del_flag,
               d.create_by,
               d.create_time
        from a_spatial_planning_interface d
    </sql>

    <sql id="selectLandSurveyVo">
        select d.id,
               d.name,
               d.status
        from a_spatial_planning_interface d
    </sql>
    <insert id="insertShpFile" parameterType="com.sinosoft.extinterface.domain.SpatialPlanning">
        insert into government_land(
        geom_data,
        item_code,
        item,
        section_code,
        section,
        generic_code,
        generic,
        bundle_code,
        bundle,
        status,
        color,
        province_name,
        area
        )values
        <foreach collection="list" item="item" index="index" separator=",">
            (
            st_geomfromtext(#{item.geomData}),
            #{item.itemCode},
            #{item.item},
            #{item.sectionCode},
            #{item.section},
            #{item.genericCode},
            #{item.generic},
            #{item.bundleCode},
            #{item.bundle},
            #{item.status},
            #{item.color},
            #{item.provinceName},
            #{item.area}
            )
        </foreach>
    </insert>

    <select id="spatialPlanningMapper" parameterType="com.sinosoft.extinterface.domain.SpatialPlanning"
            resultMap="SpatialPlanning">
        select
        id id,
        item_code,
        item,
        section_code,
        section,
        generic_code ,
        province,
        city,
        county,
        generic,
        bundle_code,
        bundle,
        status,
        color,
        grass_type,
        province_name,
        st_astext(ST_Centroid(geom_data)) as geom_data,
        st_area(geography(geom_data)) area
        from government_land
        <where>
            def_falg='0'
            <if test="section != null and section != ''">
                AND section like concat('%', #{section}, '%')
            </if>
            <if test="item != null and item != ''">
                AND item like concat('%', #{item}, '%')
            </if>
            <if test="generic != null and generic != ''">
                AND generic like concat('%', #{generic}, '%')
            </if>
            <if test="bundle != null and bundle != ''">
                AND bundle like concat('%', #{bundle}, '%')
            </if>
            <if test="provinceCode != null and provinceCode != ''">
                AND province_code =#{provinceCode}
            </if>
            <if test="cityCode != null and cityCode != ''">
                AND city_code =#{cityCode}
            </if>
            <if test="countyCode != null and countyCode != ''">
                AND county_code =#{countyCode}
            </if>
            <if test="status != null and  status.toString() !='-1'">
                AND status =#{status}
            </if>

            ORDER BY id
        </where>
    </select>
    <select id="selectShpFileById" parameterType="Long" resultMap="SpatialPlanning">
       select
       id,
       item_code itemCode,
       item,
       section_code sectionCode,
       section,
       generic_code genericCode,
       generic,
       bundle_code bundleCode,
       bundle,
       status,
       color,
       grass_type ,
       CONCAT( province,city,county)  province_Name,
       st_astext(ST_Centroid(geom_data)) as geom_data,
       st_area(geography(geom_data))   area
        from government_land
        where id = #{id}
    </select>
    <select id="checkShpFileNameUnique" resultMap="SpatialPlanning">
        <include refid="selectShpFileVo"/>
        where name=#{name} and parent_id = #{parentId}
    </select>
    <update id="updateShpFileChildren" parameterType="java.util.List">
        update a_spatial_planning_interface set ancestors =
        <foreach collection="shpFiles" item="item" index="index"
                 separator=" " open="case id" close="end">
            when #{item.id} then #{item.ancestors}
        </foreach>
        where id in
        <foreach collection="shpFiles" item="item" index="index"
                 separator="," open="(" close=")">
            #{item.id}
        </foreach>
    </update>

    <select id="selectChildrenShpFileById" parameterType="Long" resultMap="SpatialPlanning">
        select *
        from a_spatial_planning_interface
        where find_in_set(#{shpFileId}, ancestors)
    </select>
    <update id="updateShpFile" parameterType="com.sinosoft.extinterface.domain.SpatialPlanning">
        update a_spatial_planning_interface
        <set>
            <if test="parentId != null and parentId != 0">parent_id = #{parentId},</if>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="shpFilePath != null and shpFilePath != ''">shpFile_path = #{shpFilePath},</if>
            <if test="shpColor != null and shpColor != ''">shp_color = #{shpColor},</if>
            <if test="ancestors != null and ancestors != ''">ancestors = #{ancestors},</if>
            <if test="orderNum != null and orderNum != ''">order_num = #{orderNum},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            update_time = sysdate()
        </set>
        where id = #{id}
    </update>

    <select id="selectShpFileCount" parameterType="com.sinosoft.extinterface.domain.SpatialPlanning" resultType="int">
        select count(1) from a_spatial_planning_interface
        where del_flag = '0'
        <if test="id != null and id != 0">and id = #{id}</if>
        <if test="parentId != null and parentId != 0">and parent_id = #{parentId}</if>
    </select>


    <update id="deleteShpFileById" parameterType="Long">
        update a_spatial_planning_interface
        set del_flag = '2'
        where id = #{id}
    </update>


    <update id="updateShpFileStatus" parameterType="com.sinosoft.extinterface.domain.SpatialPlanning">
        update a_spatial_planning_interface
        <set>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            update_time = sysdate()
        </set>
        where id in (${ancestors})
    </update>
    <update id="updateunexamine" parameterType="Long">

         update a_spatial_planning_interface
        set status = '1'
        where id = #{id}

    </update>
    <update id="examine" parameterType="Long">

         update a_spatial_planning_interface
        set status = '0'
        where id = #{id}

    </update>

    <!--审核通过-->
    <update id="examineSpatialPlanning" parameterType="Long">
       update government_land set status =1 where id=#{id}

    </update>
    <!--审核取消-->
    <update id="unexamineSpatialPlanning" parameterType="Long">
       update government_land set status =0 where id=#{id}

    </update>
    <!--逻辑删除-->
    <update id="defFalgSpatialPlanning" parameterType="Long">
       update government_land set def_falg ='1' where id=#{id}
    </update>
    <update id="updateEditSpatialPlanning" parameterType="SpatialPlanning">
        update government_land
        set
        section = #{section},
        item = #{item},
        generic=#{generic},
        color=#{color},
        province_name=#{provinceName},
        <if test="province!=null and province!=''">
            province =#{province},
        </if>
        <if test="city!=null and city!=''">
            city =#{city},
        </if>
        <if test="county!=null and county!=''">
            county =#{county},
        </if>

        <if test="grasslandType!=null and grasslandType!=''">
            grassland_type =#{grasslandType},
        </if>
        area =#{area},
        bundle=#{bundle}
        where id=#{id}
    </update>
    <update id="updateaddFields">
        update government_land
        <set>
            <if test="province!=null and province!=''">
                province =#{province},
            </if>
            <if test="city!=null and city!=''">
                city =#{city},
            </if>
            <if test="county!=null and county!=''">
                county =#{county},
            </if>
            <if test="provinceCode!=null and provinceCode!=''">
                province_code =#{provinceCode},
            </if>
            <if test="cityCode!=null and cityCode!=''">
                city_code =#{cityCode},
            </if>
            <if test="countyCode!=null and countyCode!=''">
                county_code =#{countyCode},
            </if>

        </set>
        where id=#{id}


    </update>

</mapper>